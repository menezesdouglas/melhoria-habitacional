<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Levantamento Habitacional v18.4</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; margin: 0; padding: 0; background-color: #f8f9fa; color: #212529; }
        .container { max-width: 900px; margin: 20px auto; background-color: #ffffff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        h1, h2, h3, h4 { color: #0056b3; border-bottom: 2px solid #e9ecef; padding-bottom: 8px; }
        h4 { margin-top: 30px; }
        .bloco { border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 25px; background-color: #fff; }
        .parede-bloco, .piso-bloco { border: 1px solid #ced4da; border-radius: 5px; padding: 15px; margin-top: 15px; background-color: #f8f9fa; }
        .campo { margin-bottom: 15px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; color: #495057; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        button { background-color: #0056b3; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 10px; transition: background-color 0.2s; }
        button:hover { background-color: #004494; }
        .btn-add { background-color: #28a745; }
        .btn-add:hover { background-color: #218838; }
        .btn-pdf { background-color: #c82333; }
        .btn-pdf:hover { background-color: #a21b29; }
        .btn-toggle, .btn-toggle-service { background-color: #ffc107; color: black; font-size: 14px; padding: 8px 12px; }
        .btn-toggle:hover, .btn-toggle-service:hover { background-color: #e0a800; }
        .btn-add-small { font-size: 14px; padding: 8px 12px; margin-top: 5px; }
        .btn-remove { background-color: #dc3545; font-size: 12px; padding: 5px 10px; float: right; }
        #resumo-container { background-color: #e9ecef; border-left: 5px solid #0056b3; margin-top: 20px; padding: 20px; border-radius: 5px; font-family: "SFMono-Regular", Menlo, Monaco, Consolas, monospace; font-size: 14px; }
        #resumo { white-space: pre-wrap; word-wrap: break-word; }
        .grid-3-col { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .hidden { display: none; }
        .servico-item { padding: 15px; border: 1px solid #e9ecef; border-radius: 4px; margin-top: 10px; }
        .service-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .service-header strong { font-size: 1.1em; }
        footer { text-align: center; padding: 20px; margin-top: 40px; border-top: 1px solid #dee2e6; font-size: 14px; color: #6c757d; }
        footer a { color: #0056b3; text-decoration: none; font-weight: 600; }
        footer a:hover { text-decoration: underline; }
    </style>
</head>
<body>

<div class="container">
    <h1>Ferramenta de Levantamento v18.4</h1>

    <div class="bloco">
        <h2>Dados do Beneficiário</h2>
         <div class="collapsible-content">
            <div class="campo"><label for="nomeBeneficiario">Nome Completo:</label><input type="text" id="nomeBeneficiario"></div>
            <div class="campo"><label for="enderecoBeneficiario">Endereço:</label><input type="text" id="enderecoBeneficiario"></div>
        </div>
    </div>

    <div class="bloco">
        <h2>Dados do Responsável Técnico</h2>
        <div class="campo">
            <label for="nomeResponsavel">Nome do Responsável Técnico:</label>
            <input type="text" id="nomeResponsavel" placeholder="Digite o nome do técnico">
        </div>
    </div>
    
    <div id="bloco-cobertura" class="bloco" data-bloco-type="cobertura">
        <h2>Cobertura</h2>
        <div class="collapsible-content">
            <div class="grid-3-col">
                <div class="campo">
                    <label for="areaTelhado">Área do Telhado (m²):</label>
                    <input type="number" id="areaTelhado" placeholder="Ex: 55.5">
                </div>
                <div class="campo">
                    <label for="pdMaximo">PD Máximo (m):</label>
                    <input type="number" id="pdMaximo" placeholder="Ex: 2.80">
                </div>
                <div class="campo">
                    <label for="pdMinimo">PD Mínimo (m):</label>
                    <input type="number" id="pdMinimo" placeholder="Ex: 2.50">
                </div>
            </div>
            <div class="servicos-container"></div>
            <button class="btn-add btn-add-small" data-action="add-servico-cobertura">Adicionar Serviço à Cobertura</button>
        </div>
        <button class="btn-toggle" data-action="toggle-collapse">Concluir Seção</button>
    </div>

    <h2>Cômodos e Intervenções</h2>
    <div id="listaComodos"></div>
    <button id="addComodo" class="btn-add" data-action="add-comodo">Adicionar Cômodo</button>

    <hr style="margin: 30px 0;">
    <button id="gerarResumo" data-action="gerar-relatorio">Gerar Relatório de Texto</button>
    <button id="gerarPDF" class="btn-pdf" style="display:none;" data-action="gerar-pdf">Gerar PDF</button>

    <div id="output" style="display:none; margin-top: 20px;">
        <h3>Relatório Final</h3>
        <div id="resumo-container">
            <pre id="resumo"></pre>
        </div>
    </div>
    
    <footer>
        Desenvolvido por 
        <a href="https://github.com/menezesdouglas" target="_blank" rel="noopener noreferrer">Douglas Menezes</a> 
        & 
        <a href="https://github.com/vitoriamignon" target="_blank" rel="noopener noreferrer">Nome da Esposa</a>
    </footer>
</div>

<script>
window.jsPDF = window.jspdf.jsPDF;
let nextId = 0;

const SERVICOS_DB = {
    // Cobertura
    "remocao_cobertura_telhas": { nome: "Remoção de cobertura em telhas", unidade: "m²", tipo: "cobertura" },
    "estrutura_madeira_cobertura": { nome: "Estrutura em madeira para cobertura", unidade: "m²", tipo: "cobertura" },
    "cobertura_telha_ceramica": { nome: "Cobertura com telha cerâmica", unidade: "m²", tipo: "cobertura" },
    "cobertura_telha_fibrocimento": { nome: "Cobertura com telha fibrocimento", unidade: "m²", tipo: "cobertura" },
    "rufo_cumeeira": { nome: "Rufo/Cumeeira", unidade: "m", tipo: "cobertura_linear" },
    
    // Serviços de Parede
    "remocao_revestimento_parede": { nome: "Remoção de revestimento de parede", unidade: "m²", tipo: "parede_area_custom" },
    "alvenaria_vedacao": { nome: "Alvenaria de vedação", unidade: "m²", tipo: "parede_area_custom" },
    "corte_impermeabilizacao": { nome: "Corte e impermeabilização de parede", unidade: "m²", tipo: "parede_area_custom" },
    "embozo_parede": { nome: "Emboço paulista em paredes", unidade: "m²", tipo: "parede_area_custom" },
    "revestimento_ceramico_parede": { nome: "Revestimento cerâmico em paredes", unidade: "m²", tipo: "parede_area_custom" },
    "pintura_pva": { nome: "Preparo e pintura com tinta PVA látex", unidade: "m²", tipo: "parede_area_custom" },
    "demolicao_alvenaria": { nome: "Demolição de alvenaria c/ emboço", unidade: "m³", tipo: "parede_vol_custom" },
    "arrancamento_porta": { nome: "Arrancamento de porta de madeira", unidade: "un", tipo: "unitario_parede" },
    "arrancamento_janela": { nome: "Arrancamento de janela", unidade: "un", tipo: "unitario_parede" },
    "porta_madeira": { nome: "Porta de madeira semi-oca", unidade: "un", tipo: "unitario_parede" },
    "janela_aluminio_120x100": { nome: "Janela de correr em alumínio (1,20x1,00m)", unidade: "un", tipo: "unitario_parede" },
    "janela_aluminio_100x60": { nome: "Janela basculante alumínio (1,00x0,60m)", unidade: "un", tipo: "unitario_parede" },
    "ponto_agua_fria": { nome: "Ponto de água fria", unidade: "un", tipo: "unitario_parede" },
    "ponto_esgoto": { nome: "Ponto de esgoto", unidade: "un", tipo: "unitario_parede" },
    "ponto_tomada": { nome: "Ponto de tomada", unidade: "un", tipo: "unitario_parede" },
    "vaso_sanitario_parede": { nome: "Vaso sanitário com caixa acoplada", unidade: "un", tipo: "unitario_parede" },
    "tanque_louca_parede": { nome: "Tanque de louça", unidade: "un", tipo: "unitario_parede" },

    // Serviços de Piso
    "remocao_piso_ceramico": { nome: "Arrancamento de piso cerâmico", unidade: "m²", tipo: "piso_custom" },
    "demolicao_piso_cimentado": { nome: "Demolição de piso cimentado", unidade: "m²", tipo: "piso_custom" },
    "contrapiso_1_5cm": { nome: "Contrapiso de argamassa e=1,5cm", unidade: "m²", tipo: "piso_custom" },
    "contrapiso_5cm": { nome: "Contrapiso de argamassa e=5cm", unidade: "m²", tipo: "piso_custom" },
    "revestimento_ceramico_piso": { nome: "Piso em revestimento cerâmico", unidade: "m²", tipo: "piso_custom" },
    "lastro_concreto": { nome: "Lastro de concreto", unidade: "m³", tipo: "piso_vol_custom" },
    
    // Serviços de Teto
    "forro_pvc": { nome: "Forro de PVC", unidade: "m²", tipo: "teto_custom" },
    "ponto_iluminacao": { nome: "Ponto de iluminação c/ lâmpada LED", unidade: "un", tipo: "unitario_teto" },
    
    // Equipamentos Gerais (que não se encaixam em nenhuma superfície)
    "caixa_agua_1000l": { nome: "Caixa d'água de polietileno 1000L", unidade: "un", tipo: "equipamento_geral" },
};

function popularSelectServicos(selectElement, tiposFiltro) {
    selectElement.innerHTML = `
        <option value="">-- Escolha um serviço --</option>
        <option value="sem_intervencao">Sem intervenção</option>
    `;
    tiposFiltro.forEach(tipo => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = tipo.replace(/_/g, ' ').toUpperCase();
        for (const key in SERVICOS_DB) {
            if (SERVICOS_DB[key].tipo === tipo) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = SERVICOS_DB[key].nome;
                optgroup.appendChild(option);
            }
        }
        if (optgroup.children.length > 0) selectElement.appendChild(optgroup);
    });
}

function gerarCamposServico(servicoDiv, servicoKey) {
    const camposDiv = servicoDiv.querySelector('.campos-especificos');
    if (!servicoKey || servicoKey === 'sem_intervencao') { 
        camposDiv.innerHTML = ''; 
        return; 
    }
    camposDiv.innerHTML = ''; 

    const servico = SERVICOS_DB[servicoKey];
    let html = '';

    switch (servico.tipo) {
        case 'parede_area_custom':
            html = `<p>Informe as medidas exatas da área de aplicação:</p>
                    <div class="campo"><label>Comprimento a aplicar (m):</label><input type="number" name="custom_comp" placeholder="Ex: 3.21"></div>
                    <div class="campo"><label>Altura a aplicar (m):</label><input type="number" name="custom_alt" placeholder="Ex: 0.50"></div>
                    <p><b>Área calculada: <span class="area-total">0.00</span> m²</b></p>`;
            break;
        case 'parede_vol_custom':
            html = `<p>Informe as medidas exatas da área a ser demolida:</p>
                    <div class="campo"><label>Comprimento a demolir (m):</label><input type="number" name="custom_comp" placeholder="Ex: 0.80"></div>
                    <div class="campo"><label>Altura a demolir (m):</label><input type="number" name="custom_alt" placeholder="Ex: 2.10"></div>
                    <div class="campo"><label>Espessura (m):</label><input type="number" name="espessura" value="0.15"></div>
                    <p><b>Volume de demolição: <span class="vol-total">0.000</span> m³</b></p>`;
            break;
        case 'piso_custom': 
             html = `<p>O cálculo usará a área do piso informada para o cômodo.</p>`; 
             break;
        case 'piso_vol_custom': 
            html = `<div class="campo"><label>Espessura (m):</label><input type="number" name="espessura" value="0.05"></div><p>O cálculo usará a área do piso informada.</p>`; 
            break;
        case 'teto_custom':
             html = `<p>O cálculo usará a área do teto informada para o cômodo.</p>`; 
             break;
        case 'cobertura': html = `<p>O cálculo usará a área do telhado informada.</p>`; break;
        case 'cobertura_linear': html = `<div class="campo"><label>Comprimento (m):</label><input type="number" name="medida"></div>`; break;
        case 'unitario_parede':
        case 'equipamento_geral':
        case 'unitario_teto':
            html = `<div class="campo"><label>Quantidade:</label><input type="number" name="quantidade" value="1" step="1"></div>`; break;
    }
    camposDiv.innerHTML = html;
}

function gerarRelatorio() {
    let texto = `MEMORIAL DESCRITIVO\n\n`;
    texto += `BENEFICIÁRIO(A): ${document.getElementById('nomeBeneficiario').value}\n`;
    texto += `ENDEREÇO: ${document.getElementById('enderecoBeneficiario').value}\n`;
    texto += `RESPONSÁVEL TÉCNICO: ${document.getElementById('nomeResponsavel').value}\n`;
    const totaisGerais = {};

    // **** FUNÇÃO ATUALIZADA AQUI ****
    const processarServico = (servicoDiv) => {
        const select = servicoDiv.querySelector('select');
        const servicoKey = select?.value;

        if (!servicoKey) return null;

        // Se for "sem intervenção", retorna um objeto especial para o relatório
        if (servicoKey === 'sem_intervencao') {
            return { nome: "Sem intervenção", isIntervention: false };
        }

        const servico = SERVICOS_DB[servicoKey];
        let quant = 0, detalhe = '';
        
        const getVal = (selector, parent) => parent ? parseFloat(parent.querySelector(selector)?.value) || 0 : 0;
        
        const comodoDiv = servicoDiv.closest('.bloco[data-bloco-type="comodo"]');
        const coberturaDiv = servicoDiv.closest('.bloco[data-bloco-type="cobertura"]');

        switch (servico.tipo) {
            case 'cobertura': quant = getVal('#areaTelhado', coberturaDiv); break;
            case 'cobertura_linear': quant = getVal('[name=medida]', servicoDiv); break;
            case 'parede_area_custom':
                const customCompArea = getVal('[name=custom_comp]', servicoDiv);
                const customAltArea = getVal('[name=custom_alt]', servicoDiv);
                quant = customCompArea * customAltArea;
                detalhe = `(${customCompArea.toFixed(2)}m x ${customAltArea.toFixed(2)}m)`;
                break;
            case 'parede_vol_custom':
                const customCompVol = getVal('[name=custom_comp]', servicoDiv);
                const customAltVol = getVal('[name=custom_alt]', servicoDiv);
                const esp = getVal('[name=espessura]', servicoDiv);
                quant = customCompVol * customAltVol * esp;
                detalhe = `(${customCompVol.toFixed(2)}m x ${customAltVol.toFixed(2)}m x ${esp.toFixed(2)}m)`;
                break;
            case 'piso_custom': 
                quant = getVal('.comodo-area-piso', comodoDiv); break;
            case 'piso_vol_custom':
                 const areaPiso = getVal('.comodo-area-piso', comodoDiv);
                 const espVol = getVal('[name=espessura]', servicoDiv);
                 quant = areaPiso * espVol; detalhe = `(${areaPiso.toFixed(2)}m² x ${espVol.toFixed(2)}m)`;
                break;
            case 'teto_custom':
                quant = getVal('.comodo-area-teto', comodoDiv); break;
            case 'unitario_parede':
            case 'equipamento_geral':
            case 'unitario_teto':
                quant = parseInt(getVal('[name=quantidade]', servicoDiv)) || 0; break;
        }

        if (quant > 0) {
            if (!totaisGerais[servico.nome]) totaisGerais[servico.nome] = { total: 0, unidade: servico.unidade };
            totaisGerais[servico.nome].total += quant;
            // Adiciona a flag 'isIntervention' para serviços reais
            return { nome: servico.nome, quant: quant, unidade: servico.unidade, detalhe, isIntervention: true };
        }
        return null;
    };

    const areaTelhado = parseFloat(document.getElementById('areaTelhado').value) || 0;
    const pdMax = parseFloat(document.getElementById('pdMaximo').value) || 0;
    const pdMin = parseFloat(document.getElementById('pdMinimo').value) || 0;
    texto += `\n----------------------------------------\nCOBERTURA | Área: ${areaTelhado.toFixed(2)} m² | PD Máx: ${pdMax.toFixed(2)}m | PD Mín: ${pdMin.toFixed(2)}m\n----------------------------------------\n`;
    document.querySelectorAll('#bloco-cobertura .servico-item').forEach(servicoDiv => {
        const res = processarServico(servicoDiv);
        // **** LÓGICA DE EXIBIÇÃO ATUALIZADA ****
        if (res) {
            if (res.isIntervention) {
                 texto += `▪ ${res.nome} = ${res.quant.toFixed(2)} ${res.unidade}\n`;
            } else {
                 texto += `▪ ${res.nome}\n`;
            }
        }
    });

    document.querySelectorAll('#listaComodos > .bloco').forEach(comodoDiv => {
        const nome = comodoDiv.querySelector('.comodo-nome').value || "Cômodo";
        const pdMaxComodo = parseFloat(comodoDiv.querySelector('.comodo-pd-max').value) || 0;
        const pdMinComodo = parseFloat(comodoDiv.querySelector('.comodo-pd-min').value) || 0;
        texto += `\n----------------------------------------\nCÔMODO: ${nome.toUpperCase()} | PD Máx: ${pdMaxComodo.toFixed(2)}m | PD Mín: ${pdMinComodo.toFixed(2)}m\n----------------------------------------\n`;

        comodoDiv.querySelectorAll('.parede-bloco').forEach((paredeDiv, index) => {
            const comp = parseFloat(paredeDiv.querySelector('.parede-comprimento').value) || 0;
            texto += `\n◊ Parede ${index + 1} (${comp.toFixed(2)}m):\n`;
            paredeDiv.querySelectorAll('.servico-item').forEach(servicoDiv => {
                const res = processarServico(servicoDiv);
                // **** LÓGICA DE EXIBIÇÃO ATUALIZADA ****
                if (res) {
                    if (res.isIntervention) {
                        const casasDecimais = res.unidade === 'm³' ? 3 : (res.unidade === 'un' ? 0 : 2);
                        texto += `  ▪ ${res.nome} = ${res.quant.toFixed(casasDecimais)} ${res.unidade} ${res.detalhe}\n`;
                    } else {
                        texto += `  ▪ ${res.nome}\n`;
                    }
                }
            });
        });

        const processSubSection = (containerSelector, title, areaInfo) => {
            let subTexto = `\n◊ ${title} | Área: ${areaInfo.toFixed(2)} m²:\n`;
            let hasContent = false;
            comodoDiv.querySelectorAll(containerSelector).forEach(servicoDiv => {
                const res = processarServico(servicoDiv);
                if(res) {
                    hasContent = true;
                    // **** LÓGICA DE EXIBIÇÃO ATUALIZADA ****
                    if (res.isIntervention) {
                        const casasDecimais = res.unidade === 'm³' ? 3 : (res.unidade === 'un' ? 0 : 2);
                        subTexto += `  ▪ ${res.nome} = ${res.quant.toFixed(casasDecimais)} ${res.unidade} ${res.detalhe}\n`;
                    } else {
                        subTexto += `  ▪ ${res.nome}\n`;
                    }
                }
            });
            if (hasContent) texto += subTexto;
        };
        
        const areaPiso = parseFloat(comodoDiv.querySelector('.comodo-area-piso').value) || 0;
        const areaTeto = parseFloat(comodoDiv.querySelector('.comodo-area-teto').value) || 0;
        processSubSection('.piso-container .servico-item', 'PISO', areaPiso);
        processSubSection('.teto-container .servico-item', 'TETO', areaTeto);

        let textoServicosGerais = '\n◊ EQUIPAMENTOS GERAIS:\n';
        let temServicosGerais = false;
        comodoDiv.querySelectorAll('.equipamentos-container .servico-item').forEach(servicoDiv => {
            const res = processarServico(servicoDiv);
            if(res) {
                temServicosGerais = true;
                if (res.isIntervention) {
                    textoServicosGerais += `  ▪ ${res.nome} = ${res.quant.toFixed(0)} ${res.unidade} ${res.detalhe}\n`;
                } else {
                    textoServicosGerais += `  ▪ ${res.nome}\n`;
                }
            }
        });
        if (temServicosGerais) texto += textoServicosGerais;
    });

    texto += `\n\n========================================\nQUANTITATIVOS TOTAIS PARA ORÇAMENTO\n========================================\n`;
    for (const nome in totaisGerais) {
        const item = totaisGerais[nome];
        const casasDecimais = item.unidade === 'un' ? 0 : (item.unidade === 'm³' ? 3 : 2);
        texto += `- ${nome}: ${item.total.toFixed(casasDecimais)} ${item.unidade}\n`;
    }

    return texto;
}

async function gerarPDF() {
    document.querySelectorAll('.collapsible-content, .service-collapsible-content').forEach(el => el.classList.remove('hidden'));
    document.querySelectorAll('[data-action="toggle-collapse"]').forEach(btn => btn.textContent = 'Concluir Seção');
    document.querySelectorAll('[data-action="toggle-service"]').forEach(btn => btn.textContent = 'Fechar Serviço');

    const nomeBeneficiario = document.getElementById('nomeBeneficiario').value || "Beneficiario";
    const nomeArquivo = `Memorial_Descritivo_${nomeBeneficiario.replace(/ /g, "_")}.pdf`;
    const relatorioElement = document.getElementById('resumo-container');
    
    await html2canvas(relatorioElement, { scale: 2 }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF('p', 'pt', 'a4');
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        const imgWidth = pdfWidth - 80;
        const imgHeight = canvas.height * imgWidth / canvas.width;
        let heightLeft = imgHeight;
        let position = 40;

        pdf.addImage(imgData, 'PNG', 40, position, imgWidth, imgHeight);
        heightLeft -= (pdfHeight - 80);

        while (heightLeft > 0) {
            position -= (pdfHeight - 80);
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 40, position, imgWidth, imgHeight);
            heightLeft -= (pdfHeight - 80);
        }
        pdf.save(nomeArquivo);
    });
}

// ============ Event Listener Principais ============
function handleAppActions(e) {
    const target = e.target.closest('[data-action]');
    if (!target) return;

    e.preventDefault(); 
    const action = target.dataset.action;
    let container, tipos = [];

    switch (action) {
        case 'add-comodo':
            const comodoId = `comodo_${nextId++}`;
            const comodoDiv = document.createElement('div');
            comodoDiv.className = 'bloco';
            comodoDiv.id = comodoId;
            comodoDiv.setAttribute('data-bloco-type', 'comodo');
            comodoDiv.innerHTML = `
                <h3>Novo Cômodo <button class="btn-remove" data-action="remove-element" data-target-id="${comodoId}">Remover</button></h3>
                <div class="collapsible-content">
                    <div class="campo"><label>Nome do Cômodo:</label><input type="text" class="comodo-nome" placeholder="Ex: Cozinha"></div>
                    <div class="grid-3-col">
                         <div class="campo"><label>PD Máximo (m):</label><input type="number" class="comodo-pd-max" placeholder="Ex: 2.85"></div>
                         <div class="campo"><label>PD Mínimo (m):</label><input type="number" class="comodo-pd-min" placeholder="Ex: 2.48"></div>
                    </div>
                    
                    <h4>Paredes do Cômodo</h4>
                    <div class="paredes-container"></div>
                    <button class="btn-add btn-add-small" data-action="add-parede">Adicionar Parede</button>
                    
                    <h4>Piso do Cômodo</h4>
                    <div class="campo"><label>Área do Piso (m²):</label><input type="number" class="comodo-area-piso" placeholder="Área exata do piso"></div>
                    <div class="piso-container servicos-container"></div>
                    <button class="btn-add btn-add-small" data-action="add-servico-piso">Adicionar Serviço ao Piso</button>

                    <h4>Teto do Cômodo</h4>
                    <div class="campo"><label>Área do Teto (m²):</label><input type="number" class="comodo-area-teto" placeholder="Área exata do teto"></div>
                    <div class="teto-container servicos-container"></div>
                    <button class="btn-add btn-add-small" data-action="add-servico-teto">Adicionar Serviço ao Teto</button>

                    <h4>Equipamentos e Instalações Gerais</h4>
                    <div class="equipamentos-container servicos-container"></div>
                    <button class="btn-add btn-add-small" data-action="add-equipamento-geral">Adicionar Equipamento</button>
                </div>
                <button class="btn-toggle" data-action="toggle-collapse">Concluir Seção</button>
            `;
            document.getElementById('listaComodos').appendChild(comodoDiv);
            return;
        case 'add-servico-cobertura':
            container = target.closest('.bloco').querySelector('.servicos-container');
            tipos = ['cobertura', 'cobertura_linear'];
            break;
        case 'add-parede':
            const paredesContainer = target.closest('.bloco').querySelector('.paredes-container');
            const paredeId = `parede_${nextId++}`;
            const numParedes = paredesContainer.children.length + 1;
            const paredeDiv = document.createElement('div');
            paredeDiv.className = 'parede-bloco';
            paredeDiv.id = paredeId;
            paredeDiv.innerHTML = `
                <h5>Parede ${numParedes} <button class="btn-remove" data-action="remove-element" data-target-id="${paredeId}">X</button></h5>
                <div class="campo"><label>Comprimento da Parede (m):</label><input type="number" class="parede-comprimento"></div>
                <div class="servicos-container"></div>
                <button class="btn-add btn-add-small" data-action="add-servico-parede">Adicionar Serviço à Parede</button>
            `;
            paredesContainer.appendChild(paredeDiv);
            return; 
        case 'add-servico-parede':
            container = target.closest('.parede-bloco').querySelector('.servicos-container');
            tipos = ['parede_area_custom', 'parede_vol_custom', 'unitario_parede'];
            break;
        case 'add-servico-piso':
            container = target.closest('.bloco').querySelector('.piso-container');
            tipos = ['piso_custom', 'piso_vol_custom'];
            break;
        case 'add-servico-teto':
            container = target.closest('.bloco').querySelector('.teto-container');
            tipos = ['teto_custom', 'unitario_teto'];
            break;
        case 'add-equipamento-geral':
            container = target.closest('.bloco').querySelector('.equipamentos-container');
            tipos = ['equipamento_geral'];
            break;
        case 'remove-element':
            const elementToRemove = document.getElementById(target.dataset.targetId);
            if (elementToRemove) elementToRemove.remove();
            return;
        case 'toggle-collapse':
            const content = target.closest('.bloco').querySelector('.collapsible-content');
            content.classList.toggle('hidden');
            target.textContent = content.classList.contains('hidden') ? 'Editar' : 'Concluir Seção';
            return;
        case 'toggle-service':
            const serviceContent = target.closest('.servico-item').querySelector('.service-collapsible-content');
            serviceContent.classList.toggle('hidden');
            target.textContent = serviceContent.classList.contains('hidden') ? 'Editar Serviço' : 'Fechar Serviço';
            return;
        case 'gerar-relatorio':
            document.querySelectorAll('.collapsible-content, .service-collapsible-content').forEach(el => el.classList.remove('hidden'));
            document.querySelectorAll('[data-action="toggle-collapse"]').forEach(btn => btn.textContent = 'Concluir Seção');
            document.querySelectorAll('[data-action="toggle-service"]').forEach(btn => btn.textContent = 'Fechar Serviço');
            const textoFinal = gerarRelatorio();
            document.getElementById('resumo').textContent = textoFinal;
            document.getElementById('output').style.display = 'block';
            document.getElementById('gerarPDF').style.display = 'inline-block';
            return;
        case 'gerar-pdf':
            gerarPDF();
            return;
        default:
            return;
    }

    if (container) {
        const servicoId = `servico_${nextId++}`;
        const servicoDiv = document.createElement('div');
        servicoDiv.className = 'servico-item';
        servicoDiv.id = servicoId;
        
        const select = document.createElement('select');
        popularSelectServicos(select, tipos);

        servicoDiv.innerHTML = `<div class="service-header"></div><div class="service-collapsible-content"></div>`;
        const header = servicoDiv.querySelector('.service-header');
        const content = servicoDiv.querySelector('.service-collapsible-content');
        
        const removeBtn = document.createElement('button');
        removeBtn.className = 'btn-remove';
        removeBtn.dataset.action = 'remove-element';
        removeBtn.dataset.targetId = servicoId;
        removeBtn.textContent = 'X';

        const label = document.createElement('label');
        label.textContent = 'Serviço:';

        header.appendChild(removeBtn);
        content.appendChild(label);
        content.appendChild(select);
        content.innerHTML += `<div class="campos-especificos" style="margin-top:10px;"></div>`;
        container.appendChild(servicoDiv);
    }
}

document.addEventListener('input', (e) => {
    const target = e.target;
    const servicoDiv = target.closest('.servico-item');
    if(servicoDiv) {
        if(target.matches('[name="custom_comp"], [name="custom_alt"]')) {
            const comp = parseFloat(servicoDiv.querySelector('[name="custom_comp"]')?.value) || 0;
            const alt = parseFloat(servicoDiv.querySelector('[name="custom_alt"]')?.value) || 0;
            const totalSpan = servicoDiv.querySelector('.area-total');
            if(totalSpan) totalSpan.textContent = (comp * alt).toFixed(2);
        }
        if(target.matches('[name="custom_comp"], [name="custom_alt"], [name="espessura"]')) {
            const comp = parseFloat(servicoDiv.querySelector('[name="custom_comp"]')?.value) || 0;
            const alt = parseFloat(servicoDiv.querySelector('[name="custom_alt"]')?.value) || 0;
            const esp = parseFloat(servicoDiv.querySelector('[name="espessura"]')?.value) || 0;
            const totalSpan = servicoDiv.querySelector('.vol-total');
            if(totalSpan) totalSpan.textContent = (comp * alt * esp).toFixed(3);
        }
    }
});

document.addEventListener('change', (e) => {
    const target = e.target;
    if (target.matches('select')) {
        const servicoDiv = target.closest('.servico-item');
        if (servicoDiv) {
            gerarCamposServico(servicoDiv, target.value);
            const header = servicoDiv.querySelector('.service-header');
            if(target.value) {
                const serviceName = (target.value === 'sem_intervencao')
                    ? 'Sem intervenção'
                    : target.options[target.selectedIndex].text;
                header.innerHTML = `<strong>${serviceName}</strong><button class="btn-toggle-service" data-action="toggle-service">Fechar Serviço</button>`;
            } else {
                header.innerHTML = '';
            }
        }
    }
});

// Listener unificado para click e touch
['click', 'touchend'].forEach(evt => {
    document.addEventListener(evt, handleAppActions);
});
</script>
</body>
</html>