<!DOCTYPE html>
<html lang="pt-BR"> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Levantamento Habitacional v20.6</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script>
        (function() {
            const theme = localStorage.getItem('theme');
            if (theme === 'dark') {
                document.documentElement.classList.add('dark-mode');
            }
        })();
    </script>

    <style>
        /* --- VARIÁVEIS DE COR (TEMA CLARO COMO PADRÃO) --- */
        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --container-bg: #ffffff;
            --bloco-bg: #fff;
            --bloco-nested-bg: #f8f9fa;
            --border-color: #dee2e6;
            --border-color-input: #ced4da;
            --header-color: #0056b3;
            --header-border: #e9ecef;
            --label-color: #495057;
            --link-color: #0056b3;
            --resumo-bg: #e9ecef;
            --btn-remove-hover-bg: #f1f1f1;
            --btn-remove-hover-color: #dc3545;
        }

        /* --- ESTILOS DO TEMA ESCURO --- */
        html.dark-mode {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --container-bg: #1e1e1e;
            --bloco-bg: #1e1e1e;
            --bloco-nested-bg: #2a2a2a;
            --border-color: #3a3a3a;
            --border-color-input: #4a4a4a;
            --header-color: #4dabf7;
            --header-border: #3a3a3a;
            --label-color: #b3b3b3;
            --link-color: #4dabf7;
            --resumo-bg: #2a2a2a;
            --btn-remove-hover-bg: #3a3a3a;
            --btn-remove-hover-color: #ff6b6b;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            line-height: 1.6; 
            margin: 0; 
            padding: 0; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            transition: background-color 0.3s, color 0.3s;
        }
        .container { 
            max-width: 900px; 
            margin: 20px auto; 
            background-color: var(--container-bg); 
            padding: 25px; 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .header-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--header-border);
            padding-bottom: 8px;
        }
        h1 { border-bottom: none; padding-bottom: 0; margin: 0; }
        h1, h2, h3, h4, h5 { color: var(--header-color); }
        h2, h3, h4 { border-bottom: 2px solid var(--header-border); padding-bottom: 8px; }
        h4 { margin-top: 30px; }
        h3, h5 { display: flex; justify-content: space-between; align-items: center; }
        .bloco { 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            padding: 20px; 
            margin-bottom: 25px; 
            background-color: var(--bloco-bg);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .parede-bloco, .piso-bloco, .comentario-bloco { 
            border: 1px solid var(--border-color-input); 
            border-radius: 5px; 
            padding: 15px; 
            margin-top: 15px; 
            background-color: var(--bloco-nested-bg);
        }
        .campo { margin-bottom: 15px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; color: var(--label-color); }
        input, select, textarea { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid var(--border-color-input); 
            border-radius: 4px; 
            box-sizing: border-box; 
            font-size: 16px; 
            background-color: var(--bloco-bg);
            color: var(--text-color);
        }
        input::placeholder, textarea::placeholder { color: var(--label-color); opacity: 0.7; }
        textarea { min-height: 80px; }
        button { background-color: #0056b3; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 10px; transition: background-color 0.2s; }
        button:hover { background-color: #004494; }
        .btn-add { background-color: #28a745; }
        .btn-add:hover { background-color: #218838; }
        .btn-pdf { background-color: #c82333; }
        .btn-pdf:hover { background-color: #a21b29; }
        .btn-save { background-color: #17a2b8; }
        .btn-save:hover { background-color: #138496; }
        .btn-load { background-color: #6c757d; }
        .btn-load:hover { background-color: #5a6268; }
        .btn-toggle, .btn-toggle-service, .btn-finalizar { background-color: #ffc107; color: black; font-size: 14px; padding: 8px 12px; }
        .btn-toggle:hover, .btn-toggle-service:hover, .btn-finalizar:hover { background-color: #e0a800; }
        .btn-add-small { font-size: 14px; padding: 8px 12px; margin-top: 5px; }
        .botoes-acoes { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn-remove {
            background: transparent;
            border: none;
            color: #6c757d;
            padding: 5px;
            margin: 0;
            margin-left: 10px;
            cursor: pointer;
            line-height: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s, color 0.2s;
        }
        .btn-remove svg { width: 18px; height: 18px; }
        .btn-remove:hover { color: var(--btn-remove-hover-color); background-color: var(--btn-remove-hover-bg); }
        #resumo-container { background-color: var(--resumo-bg); border-left: 5px solid var(--header-color); margin-top: 20px; padding: 20px; border-radius: 5px; font-family: "SFMono-Regular", Menlo, Monaco, Consolas, monospace; font-size: 14px; }
        #resumo { white-space: pre-wrap; word-wrap: break-word; }
        .grid-3-col { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .hidden { display: none; }
        .servico-item { padding: 15px; border: 1px solid var(--header-border); border-radius: 4px; margin-top: 10px; }
        .service-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }
        .service-header strong { font-size: 1.1em; flex-grow: 1; }
        .header-buttons { display: flex; align-items: center; flex-shrink: 0; }
        .comment-text { margin: 5px 0; font-style: italic; color: var(--label-color); }
        footer { text-align: center; padding: 20px; margin-top: 40px; border-top: 1px solid var(--border-color); font-size: 14px; color: #6c757d; }
        footer a { color: var(--link-color); text-decoration: none; font-weight: 600; }
        footer a:hover { text-decoration: underline; }
        .save-status {
            font-size: 12px;
            color: #28a745;
            margin-left: 15px;
            display: inline-block;
            opacity: 0;
            transition: opacity 0.5s;
        }

        /* --- ESTILOS DO BOTÃO DE TEMA --- */
        #theme-toggle {
            background: none;
            border: 1px solid var(--border-color-input);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            padding: 8px;
            cursor: pointer;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #theme-toggle:hover {
             background-color: var(--bloco-nested-bg);
        }
        #theme-toggle svg {
            width: 100%;
            height: 100%;
            fill: var(--text-color);
        }
        .sun-icon { display: none; }
        html.dark-mode .sun-icon { display: block; }
        html.dark-mode .moon-icon { display: none; }
        
    </style>
</head>
<body>
<div class="container">
    <div class="header-main">
        <h1>Levantamento v20.6</h1>
        <button id="theme-toggle" title="Alternar tema">
            <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 9c-1.65 0-3 1.35-3 3s1.35 3 3 3 3-1.35 3-3-1.35-3-3-3zm0 4c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm8-4h-2.1c-.45-.75-.98-1.42-1.57-2L17.75 6.25l-1.42-1.42L15 6.25C14.3 5.66 13.53 5.18 12.68 4.82L13 3h-2L10.68 4.82C9.83 5.18 9.07 5.66 8.37 6.25L7 4.83 5.58 6.25 6.9 7.57c-.59.58-1.12 1.25-1.57 2H3v2h2.1c.45.75.98 1.42 1.57 2L6.25 16.25l1.42 1.42L9 16.25c.7.59 1.47 1.07 2.32 1.42L11 19h2l.32-1.82c.85-.35 1.62-.83 2.32-1.42l1.42 1.42 1.42-1.42-1.32-1.32c.59-.58 1.12-1.25 1.57-2H21V9z"/></svg>
            <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M11.1 12.08c-2.33-4.51-.5-8.48.53-10.07-1.7.21-3.33.89-4.73 2.05-3.16 2.6-3.95 7.33-1.94 10.7C7.17 18.66 11.02 21 15.21 21c2.04 0 3.96-.64 5.57-1.84-1.64.93-3.4 1.48-5.23 1.48-3.59 0-6.75-2.27-7.95-5.56z"/></svg>
        </button>
    </div>

    <div class="bloco">
        <h2>Dados do Beneficiário</h2>
        <div class="collapsible-content">
            <div class="campo"><label for="nomeBeneficiario">Nome Completo:</label><input type="text" id="nomeBeneficiario"></div>
            <div class="campo"><label for="enderecoBeneficiario">Endereço:</label><input type="text" id="enderecoBeneficiario"></div>
        </div>
    </div>
    <div class="bloco">
        <h2>Dados do Responsável Técnico</h2>
        <div class="campo">
            <label for="nomeResponsavel">Nome do Responsável Técnico:</label>
            <input type="text" id="nomeResponsavel" placeholder="Digite o nome do técnico">
        </div>
    </div>
    <div id="bloco-cobertura" class="bloco" data-bloco-type="cobertura">
        <h2>Cobertura</h2>
        <div class="collapsible-content">
            <div class="grid-3-col">
                <div class="campo">
                    <label for="areaTelhado">Área do Telhado (m²):</label>
                    <input type="number" id="areaTelhado" placeholder="Ex: 55.5" min="0" step="0.01">
                </div>
                <div class="campo">
                    <label for="pdMaximo">PD Máximo (m):</label>
                    <input type="number" id="pdMaximo" placeholder="Ex: 2.80" min="0" step="0.01">
                </div>
                <div class="campo">
                    <label for="pdMinimo">PD Mínimo (m):</label>
                    <input type="number" id="pdMinimo" placeholder="Ex: 2.50" min="0" step="0.01">
                </div>
            </div>
            <div class="servicos-container"></div>
            <div class="comentarios-container"></div>
            <div class="botoes-acoes">
                <button class="btn-add btn-add-small" data-action="add-servico-cobertura" aria-label="Adicionar serviço à cobertura">Adicionar Serviço à Cobertura</button>
                <button class="btn-add-small" data-action="add-comentario" aria-label="Adicionar comentário">Adicionar Comentário</button>
            </div>
        </div>
        <button class="btn-toggle" data-action="toggle-collapse" aria-label="Concluir ou editar seção de cobertura">Concluir Seção</button>
    </div>
    <h2>Cômodos e Intervenções</h2>
    <div id="listaComodos"></div>
    <button id="addComodo" class="btn-add" data-action="add-comodo" aria-label="Adicionar novo cômodo">Adicionar Cômodo</button>
    <hr style="margin: 30px 0;">
    
    <div class="botoes-acoes">
        <button id="gerarResumo" data-action="gerar-relatorio" aria-label="Gerar relatório de texto">Gerar Relatório</button>
        <button id="salvarProgresso" data-action="salvar-progresso" class="btn-save" aria-label="Salvar progresso">Salvar Progresso</button>
        <button id="carregarProgresso" data-action="carregar-progresso" class="btn-load" aria-label="Carregar progresso">Carregar Progresso</button>
        <button id="gerarPDF" class="btn-pdf" style="display:none;" data-action="gerar-pdf" aria-label="Gerar PDF do relatório">Gerar PDF</button>
        <span id="saveStatus" class="save-status"></span>
    </div>

    <div id="output" style="display:none; margin-top: 20px;">
        <h3>Relatório Final</h3>
        <div id="resumo-container">
            <pre id="resumo"></pre>
        </div>
    </div>
    <footer>
        Desenvolvido por
        <a href="https://github.com/menezesdouglas" target="_blank" rel="noopener noreferrer">Douglas Menezes</a>
        &
        <a href="https://github.com/vitoriamignon" target="_blank" rel="noopener noreferrer">Vitoria Mignon</a>
    </footer>
</div>

<script>
const REMOVE_ICON_SVG = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>`;
window.jsPDF = window.jspdf.jsPDF;
let nextId = 0;
const STORAGE_KEY = 'levantamentoHabitacionalProgresso';


const SERVICOS_DB = {
    "estrutura_madeira_cobertura": { nome: "Estrutura em madeira para cobertura", unidade: "m²", tipo: "cobertura" },
    "remocao_telha_francesa_ex_madeiramento": { nome: "Remoção de cobertura em telhas francesas (exclusivo madeiramento)", unidade: "m²", tipo: "cobertura" },
    "remocao_telha_francesa_inclusive": { nome: "Remoção de cobertura em telhas francesas (inclusive)", unidade: "m²", tipo: "cobertura" },
    "retirada_recolocacao_telhas_francesas": { nome: "Retirada e recolocação de telhas francesas (inclusive)", unidade: "m²", tipo: "cobertura" },
    "cumeeira_recolocacao": { nome: "Cumeeira (exclusive fornecimento de material novo)", unidade: "m²", tipo: "cobertura" },
    "retirada_recolocacao_madeiramento": { nome: "Retirada e recolocação de madeiramento (telhas francesas/coloniais)", unidade: "m²", tipo: "cobertura" },
    "trama_madeira_completa": { nome: "Trama de madeira (ripas, caibros, terças) para telhados de até 2 águas", unidade: "m²", tipo: "cobertura" },
    "cobertura_telha_ceramica_francesa": { nome: "Cobertura em telha ceramica francesa (exclusive cumeeira e madeiramento)", unidade: "m²", tipo: "cobertura" },
    "remocao_cobertura_fibrocimento_ex_madeiramento": { nome: "Remoção de cobertura de fibrocimento (exclusive madeiramento)", unidade: "m²", tipo: "cobertura" },
    "retirada_recolocacao_madeiramento_fibrocimento": { nome: "Retirada e recolocação de madeiramento (telhas fibrocimento)", unidade: "m²", tipo: "cobertura" },
    "remocao_cobertura_fibrocimento_inclusive": { nome: "Remoção de cobertura de fibrocimento (inclusive madeiramento)", unidade: "m²", tipo: "cobertura" },
    "madeiramento_cobertura_onduladas": { nome: "Madeiramento para cobertura em telhas onduladas", unidade: "m²", tipo: "cobertura" },
    "cobertura_telhas_crfs_6mm": { nome: "Cobertura em telhas de cimento CRFS 6mm (sem amianto)", unidade: "m²", tipo: "cobertura" },
    "beiral_fibrocimento_60cm": { nome: "Beiral de telhas onduladas de fibrocimento 6mm, projeção 60cm", unidade: "m", tipo: "cobertura_linear" },
    "beiral_fibrocimento_120cm": { nome: "Beiral de telhas onduladas de fibrocimento 6mm, projeção 120cm", unidade: "m", tipo: "cobertura_linear" },
    "calha_beiral_pvc_dn125": { nome: "Calha de beiral semi-circular de PVC, DN 125", unidade: "m", tipo: "cobertura_linear" },
    "condutor_circular_pvc_dn88": { nome: "Condutor circular para calha de beiral de PVC, DN 88", unidade: "m", tipo: "cobertura_linear" },
    "caibro_madeira_3x1_5": { nome: "Caibro de madeira serrada 3\"x1.1/2\"", unidade: "m", tipo: "cobertura_linear" },
    "ripa_madeira_1_5x4cm": { nome: "Ripa de madeira serrada 1,5x4cm", unidade: "m", tipo: "cobertura_linear" },
    "terca_madeira_3x3": { nome: "Terça de madeira serrada 3\"x3\"", unidade: "m", tipo: "cobertura_linear" },
    "terca_madeira_aparelhada_3x4_5": { nome: "Terça de madeira aparelhada 3\"x4.1/2\"", unidade: "m", tipo: "cobertura_linear" },
    "remocao_revestimento_parede": { nome: "Remoção de revestimento de paredes", unidade: "m²", tipo: "parede_area_custom" },
    "alvenaria_vedacao": { nome: "Alvenaria de vedação", unidade: "m²", tipo: "parede_area_custom" },
    "corte_impermeabilizacao": { nome: "Corte e impermeabilização de paredes", unidade: "m²", tipo: "parede_area_custom" },
    "embozo_parede": { nome: "Emboço paulista em paredes", unidade: "m²", tipo: "parede_area_custom" },
    "revestimento_ceramico_parede": { nome: "Revestimento cerâmico em paredes", unidade: "m²", tipo: "parede_area_custom" },
    "pintura_pva": { nome: "Preparo e pintura com tinta PVA látex", unidade: "m²", tipo: "parede_area_custom" },
    "demolicao_alvenaria": { nome: "Demolição de alvenaria c/ emboço", unidade: "m³", tipo: "parede_vol_custom" },
    "arrancamento_porta": { nome: "Arrancamento de porta de madeira", unidade: "un", tipo: "unitario_parede" },
    "arrancamento_janela": { nome: "Arrancamento de janela", unidade: "un", tipo: "unitario_parede" },
    "porta_madeira": { nome: "Porta de madeira semi-oca", unidade: "un", tipo: "unitario_parede" },
    "janela_aluminio_120x100": { nome: "Janela de correr em alumínio (1,20x1,00m)", unidade: "un", tipo: "unitario_parede" },
    "janela_aluminio_100x60": { nome: "Janela basculante alumínio (1,00x0,60m)", unidade: "un", tipo: "unitario_parede" },
    "ponto_agua_fria": { nome: "Ponto de água fria", unidade: "un", tipo: "unitario_parede" },
    "ponto_esgoto": { nome: "Ponto de esgoto", unidade: "un", tipo: "unitario_parede" },
    "ponto_tomada": { nome: "Ponto de tomada", unidade: "un", tipo: "unitario_parede" },
    "vaso_sanitario_parede": { nome: "Vaso sanitário com caixa acoplada", unidade: "un", tipo: "unitario_parede" },
    "tanque_louca_parede": { nome: "Tanque de louça", unidade: "un", tipo: "unitario_parede" },
    "enchimento_piso_concreto": { nome: "ENCHIMENTO DE PISO COM ESCOMBRO DAS PROPRIAS EDIFICACOES, ATE UMA ALTURA MAXIMA DE 80CM", unidade: "m³", tipo: "piso_vol_custom" },
    "demolicao_piso_ladrilho": { nome: "DEMOLICAO DE PISO DE LADRILHO COM RESPECTIVA CAMADA DE ARGAMASSA DE ASSENTAMENTO", unidade: "m²", tipo: "piso_custom" },
    "demolicao_manual_piso_cimentado": { nome: "DEMOLICAO MANUAL DE PISO CIMENTADO E DA RESPECTIVA BASE DE CONCRETO", unidade: "m²", tipo: "piso_custom" },
    "piso_cimentado_1_5cm": { nome: "PISO CIMENTADO,COM 1,5CM DE ESPESSURA,COM ARGAMASSA DE CIMENTO E AREIA,NO TRACO 1:3", unidade: "m²", tipo: "piso_custom" },
    "contrapiso_regularizadora_1_5cm": { nome: "CONTRAPISO,BASE OU CAMADA REGULARIZADORA,EXECUTADA COM ARGAMASSA DE CIMENTO A AREIA,NO TRACO 1:4,NA ESPESSURA DE 1,5CM", unidade: "m²", tipo: "piso_custom" },
    "contrapiso_regularizadora_5cm": { nome: "CONTRAPISO,BASE OU CAMADA REGULARIZADORA,EXECUTADA COM ARGAMASSA DE CIMENTO E AREIA,NO TRACO 1:4,NA ESPESSURA DE 5CM", unidade: "m²", tipo: "piso_custom" },
    "revestimento_ceramico_antiderrapante_45x45": { nome: "REVESTIMENTO DE PISO COM LADRILHO CERAMICO,ANTIDERRAPANTE,MEDIDAS EM TORNO DE (45x45)CM", unidade: "m²", tipo: "piso_custom" },
    "soleira_granito_cinza_andorinha_2cm_15_18cm": { nome: "SOLEIRA EM GRANITO CINZA ANDORINHA,ESPESSURA DE 2CM, LARGURA 15 A 18CM", unidade: "m", tipo: "piso_linear" },
    "soleira_granito_cinza_andorinha_2cm_20_22cm": { nome: "SOLEIRA EM GRANITO CINZA ANDORINHA,ESPESSURA DE 2CM,COM 2 POLIMENTOS, LARGURA DE 20-22CM", unidade: "m", tipo: "piso_linear" },
    "pedra_box_banheiro_granito_tento_5cm": { nome: "PEDRA PARA BOX DE BANHEIRO EM GRANITO (TENTO), SEM REBAIXO, COM 5CM DE ALTURA", unidade: "m", tipo: "piso_linear" },
    "rodape_ladrilho_ceramico_7_10cm": { nome: "RODAPE COM LADRILHO CERAMICO,COM 7,5 A 10CM DE ALTURA", unidade: "m", tipo: "piso_linear" },
    "peitoril_granito_cinza_andorinha_2cm_15_18cm": { nome: "PEITORIL EM GRANITO CINZA ANDORINHA,ESPESSURA DE 2CM,LARGURA 15 A 18CM", unidade: "m", tipo: "piso_linear" },
    "soleira_granito_cinza_andorinha_2cm_15_20cm": { nome: "SOLEIRA EM GRANITO CINZA ANDORINHA,ESPESSURA DE 2CM,COM 2 POLIMENTOS, LARGURA DE 15-20CM", unidade: "m", tipo: "piso_linear" },
    "pedra_box_banheiro_granito_tento_reto_5cm": { nome: "PEDRA PARA BOX DE BANHEIRO EM GRANITO (TENTO), SEM REBAIXO, COM 5CM DE ALTURA, ASSENTE COMO EM 13.045.0040", unidade: "m", tipo: "piso_linear" },
    "aterramento_completo": { nome: "ATERRAMENTO COMPOSTO POR 1 CAIXA 25X25CM, 1 HASTE DE COBRE 5/8\", 1 CONECTOR, 6M DE CABO", unidade: "un", tipo: "piso_unitario" },
    "remocao_forro_estuque_gesso": { nome: "Remoção de forro de estuque, gesso, placas prensadas", unidade: "m²", tipo: "teto_custom" },
    "remocao_forro_lambri_madeira_pvc": { nome: "Remoção de forro ou lambri de madeira ou PVC", unidade: "m²", tipo: "teto_custom" },
    "forro_pvc_reguas_200mm": { nome: "Forro de PVC em réguas de 200mm (inclusive estrutura)", unidade: "m²", tipo: "teto_custom" },
    "instalacao_ponto_luz_2varas": { nome: "Instalação de ponto de luz (equiv. 2 varas de eletroduto)", unidade: "un", tipo: "unitario_teto" },
    "instalacao_conjunto_2pontos_luz": { nome: "Instalação de conjunto de 2 pontos de luz (equiv. 5 varas)", unidade: "un", tipo: "unitario_teto" },
    "instalacao_conjunto_3pontos_luz": { nome: "Instalação de conjunto de 3 pontos de luz (equiv. 6 varas)", unidade: "un", tipo: "unitario_teto" },
    "lampada_led_bulbo_a60": { nome: "Lâmpada LED, bulbo, A60, 8W", unidade: "un", tipo: "unitario_teto" },
    "globo_esferico_plafonier": { nome: "Globo esférico 10x15cm e plafonier em alumínio", unidade: "un", tipo: "unitario_teto" },
    "reparacao_estrutural_geral": { nome: "Reparação estrutural (remoção, limpeza, tratamento, recomposição)", unidade: "m²", tipo: "estrutural_area" },
    "concreto_baldrames_15x40": { nome: "Formas, armaduras e concreto para baldrames 15x40cm", unidade: "m", tipo: "estrutural_linear" },
    "concreto_sapata_60x60x30": { nome: "Formas, armaduras e concreto para sapata 60x60x30cm", unidade: "un", tipo: "estrutural_unitario" },
    "concreto_laje_h12": { nome: "Formas, armaduras e concreto para laje h=12cm", unidade: "m²", tipo: "estrutural_area" },
    "concreto_pilares_vigas_cintas_15x30": { nome: "Formas, armaduras e concreto para pilares/vigas/cintas 15x30cm", unidade: "m", tipo: "estrutural_linear" },
    "caixa_agua_1000l": { nome: "Caixa d'água de polietileno 1000L", unidade: "un", tipo: "equipamento_geral" },
};

function popularSelectServicos(selectElement, tiposFiro) {
    selectElement.innerHTML = `<option value="">-- Escolha um serviço --</option><option value="sem_intervencao">Sem intervenção</option>`;
    tiposFiro.forEach(tipo => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = tipo.replace(/_/g, ' ').toUpperCase();
        for (const key in SERVICOS_DB) {
            if (SERVICOS_DB[key].tipo === tipo) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = SERVICOS_DB[key].nome;
                optgroup.appendChild(option);
            }
        }
        if (optgroup.children.length > 0) selectElement.appendChild(optgroup);
    });
}

function gerarCamposServico(servicoDiv, servicoKey) {
    const camposDiv = servicoDiv.querySelector('.campos-especificos');
    if (!servicoKey || servicoKey === 'sem_intervencao') {
        camposDiv.innerHTML = '';
        return;
    }
    camposDiv.innerHTML = '';

    const servico = SERVICOS_DB[servicoKey];
    let html = '';
    switch (servico.tipo) {
        case 'parede_area_custom':
        case 'estrutural_area':
            html = `<p>Informe as medidas exatas da área de aplicação:</p><div class="campo"><label>Comprimento a aplicar (m):</label><input type="number" name="custom_comp" placeholder="Ex: 3.21" min="0" step="0.01"></div><div class="campo"><label>Largura a aplicar (m):</label><input type="number" name="custom_larg" placeholder="Ex: 0.50" min="0" step="0.01"></div><p><b>Área calculada: <span class="area-total">0.00</span> m²</b></p>`;
            break;
        case 'parede_vol_custom':
            html = `<p>Informe as medidas exatas da área a ser demolida:</p><div class="campo"><label>Comprimento a demolir (m):</label><input type="number" name="custom_comp" placeholder="Ex: 0.80" min="0" step="0.01"></div><div class="campo"><label>Altura a demolir (m):</label><input type="number" name="custom_alt" placeholder="Ex: 2.10" min="0" step="0.01"></div><div class="campo"><label>Espessura (m):</label><input type="number" name="espessura" value="0.15" min="0" step="0.01"></div><p><b>Volume de demolição: <span class="vol-total">0.000</span> m³</b></p>`;
            break;
        case 'piso_custom': html = `<p>O cálculo usará a área do piso informada para o cômodo.</p>`; break;
        case 'piso_vol_custom': html = `<div class="campo"><label>Espessura (m):</label><input type="number" name="espessura" value="0.05" min="0" step="0.01"></div><p>O cálculo usará a área do piso informada.</p>`; break;
        case 'teto_custom': html = `<p>O cálculo usará a área do teto informada para o cômodo.</p>`; break;
        case 'cobertura': html = `<p>O cálculo usará a área do telhado informada.</p>`; break;
        case 'cobertura_linear':
        case 'estrutural_linear':
        case 'piso_linear':
            html = `<div class="campo"><label>Comprimento (m):</label><input type="number" name="medida" min="0" step="0.01"></div>`; break;
        case 'unitario_parede':
        case 'equipamento_geral':
        case 'unitario_teto':
        case 'estrutural_unitario':
        case 'piso_unitario':
            html = `<div class="campo"><label>Quantidade:</label><input type="number" name="quantidade" value="1" min="1" step="1"></div>`; break;
    }
    camposDiv.innerHTML = html;
}

function gerarRelatorio() {
    let texto = `MEMORIAL DESCRITIVO\n\n`;
    texto += `BENEFICIÁRIO(A): ${document.getElementById('nomeBeneficiario').value}\n`;
    texto += `ENDEREÇO: ${document.getElementById('enderecoBeneficiario').value}\n`;
    texto += `RESPONSÁVEL TÉCNICO: ${document.getElementById('nomeResponsavel').value}\n`;
    const totaisGerais = {};

    const processarServico = (servicoDiv) => {
        const select = servicoDiv.querySelector('select');
        const servicoKey = select?.value;

        if (!servicoKey) return null;
        if (servicoKey === 'sem_intervencao') return { nome: "Sem intervenção", isIntervention: false };

        const servico = SERVICOS_DB[servicoKey];
        let quant = 0, detalhe = '';
        const getVal = (selector, parent) => parent ? parseFloat(parent.querySelector(selector)?.value) || 0 : 0;
        const comodoDiv = servicoDiv.closest('.bloco[data-bloco-type="comodo"]');
        const coberturaDiv = servicoDiv.closest('.bloco[data-bloco-type="cobertura"]');

        switch (servico.tipo) {
            case 'cobertura': quant = getVal('#areaTelhado', coberturaDiv); break;
            case 'cobertura_linear':
            case 'estrutural_linear':
            case 'piso_linear':
                quant = getVal('[name=medida]', servicoDiv);
                break;
            case 'parede_area_custom':
                const customCompArea = getVal('[name=custom_comp]', servicoDiv);
                const customLargArea = getVal('[name=custom_larg]', servicoDiv);
                quant = customCompArea * customLargArea;
                detalhe = `(${customCompArea.toFixed(2)}m x ${customLargArea.toFixed(2)}m)`;
                break;
            case 'estrutural_area':
                const compEstrutural = getVal('[name=custom_comp]', servicoDiv);
                const largEstrutural = getVal('[name=custom_larg]', servicoDiv);
                quant = compEstrutural * largEstrutural;
                detalhe = `(${compEstrutural.toFixed(2)}m x ${largEstrutural.toFixed(2)}m)`;
                break;
            case 'parede_vol_custom':
                const customCompVol = getVal('[name=custom_comp]', servicoDiv);
                const customAltVol = getVal('[name=custom_alt]', servicoDiv);
                const esp = getVal('[name=espessura]', servicoDiv);
                quant = customCompVol * customAltVol * esp;
                detalhe = `(${customCompVol.toFixed(2)}m x ${customAltVol.toFixed(2)}m x ${esp.toFixed(2)}m)`;
                break;
            case 'piso_custom': quant = getVal('.comodo-area-piso', comodoDiv); break;
            case 'piso_vol_custom':
                const areaPiso = getVal('.comodo-area-piso', comodoDiv);
                const espVol = getVal('[name=espessura]', servicoDiv);
                quant = areaPiso * espVol;
                detalhe = `(${areaPiso.toFixed(2)}m² x ${espVol.toFixed(2)}m)`;
                break;
            case 'teto_custom':
                quant = getVal('.comodo-area-teto', comodoDiv); break;
            case 'unitario_parede':
            case 'equipamento_geral':
            case 'unitario_teto':
            case 'estrutural_unitario':
            case 'piso_unitario':
                quant = parseInt(getVal('[name=quantidade]', servicoDiv)) || 0; break;
        }

        if (quant > 0) {
            if (!totaisGerais[servico.nome]) totaisGerais[servico.nome] = { total: 0, unidade: servico.unidade };
            totaisGerais[servico.nome].total += quant;
            return { nome: servico.nome, quant: quant, unidade: servico.unidade, detalhe, isIntervention: true };
        }
        return null;
    };

    const processarComentarios = (containerElement) => {
        let comentariosTexto = '';
        containerElement.querySelectorAll('.comentario-bloco').forEach(comentarioDiv => {
            const textarea = comentarioDiv.querySelector('textarea');
            if (textarea && textarea.value.trim() !== '') {
                comentariosTexto += `  ▪ Observação: ${textarea.value.trim()}\n`;
            }
        });
        return comentariosTexto;
    };

    // Cobertura
    const areaTelhado = parseFloat(document.getElementById('areaTelhado').value) || 0;
    const pdMax = parseFloat(document.getElementById('pdMaximo').value) || 0;
    const pdMin = parseFloat(document.getElementById('pdMinimo').value) || 0;
    texto += `\n----------------------------------------\nCOBERTURA | Área: ${areaTelhado.toFixed(2)} m² | PD Máx: ${pdMax.toFixed(2)}m | PD Mín: ${pdMin.toFixed(2)}m\n----------------------------------------\n`;
    document.querySelectorAll('#bloco-cobertura .servico-item').forEach(servicoDiv => {
        const res = processarServico(servicoDiv);
        if (res) {
            texto += res.isIntervention ? `▪ ${res.nome} = ${res.quant.toFixed(2)} ${res.unidade}\n` : `▪ ${res.nome}\n`;
        }
    });
    texto += processarComentarios(document.getElementById('bloco-cobertura'));

    // Cômodos
    document.querySelectorAll('#listaComodos > .bloco').forEach(comodoDiv => {
        const nome = comodoDiv.querySelector('.comodo-nome').value || "Cômodo";
        const pdMaxComodo = parseFloat(comodoDiv.querySelector('.comodo-pd-max').value) || 0;
        const pdMinComodo = parseFloat(comodoDiv.querySelector('.comodo-pd-min').value) || 0;
        texto += `\n----------------------------------------\nCÔMODO: ${nome.toUpperCase()} | PD Máx: ${pdMaxComodo.toFixed(2)}m | PD Mín: ${pdMinComodo.toFixed(2)}m\n----------------------------------------\n`;

        // Paredes
        comodoDiv.querySelectorAll('.parede-bloco').forEach((paredeDiv, index) => {
            const comp = parseFloat(paredeDiv.querySelector('.parede-comprimento').value) || 0;
            texto += `\n◊ Parede ${index + 1} (${comp.toFixed(2)}m):\n`;
            paredeDiv.querySelectorAll('.servico-item').forEach(servicoDiv => {
                const res = processarServico(servicoDiv);
                if (res) {
                    const casasDecimais = res.unidade === 'm³' ? 3 : (res.unidade === 'un' ? 0 : 2);
                    texto += res.isIntervention ? `  ▪ ${res.nome} = ${res.quant.toFixed(casasDecimais)} ${res.unidade} ${res.detalhe}\n` : `  ▪ ${res.nome}\n`;
                }
            });
            texto += processarComentarios(paredeDiv);
        });

        // Reparo Estrutural
        let textoEstrutural = '';
        let temServicoEstrutural = false;
        comodoDiv.querySelectorAll('.estrutural-container .servico-item').forEach(servicoDiv => {
            const res = processarServico(servicoDiv);
            if (res) {
                if (!temServicoEstrutural) {
                    textoEstrutural += '\n◊ REPARO ESTRUTURAL:\n';
                    temServicoEstrutural = true;
                }
                const casasDecimais = res.unidade === 'm³' ? 3 : (res.unidade === 'un' ? 0 : 2);
                textoEstrutural += res.isIntervention ? `  ▪ ${res.nome} = ${res.quant.toFixed(casasDecimais)} ${res.unidade} ${res.detalhe}\n` : `  ▪ ${res.nome}\n`;
            }
        });
        const comentariosEstruturais = processarComentarios(comodoDiv.querySelector('.estrutural-container').nextElementSibling);
        if (comentariosEstruturais) {
            if (!temServicoEstrutural) textoEstrutural += '\n◊ REPARO ESTRUTURAL:\n';
            textoEstrutural += comentariosEstruturais;
        }
        if (textoEstrutural) texto += textoEstrutural;

        // Função auxiliar para processar subseções como Piso, Teto e Equipamentos
        const processSubSection = (containerSelector, title, areaInfo) => {
            let subTexto = '';
            let hasContent = false;
            const servicesContainer = comodoDiv.querySelector(containerSelector);
            if (!servicesContainer) return ''; 

            servicesContainer.querySelectorAll('.servico-item').forEach(servicoDiv => {
                const res = processarServico(servicoDiv);
                if (res) {
                    if (!hasContent) {
                        const areaText = (areaInfo !== null && areaInfo > 0) ? ` | Área: ${areaInfo.toFixed(2)} m²` : '';
                        subTexto += `\n◊ ${title}${areaText}:\n`;
                    }
                    hasContent = true;
                    const casasDecimais = res.unidade === 'm³' ? 3 : (res.unidade === 'un' ? 0 : 2);
                    subTexto += res.isIntervention ? `  ▪ ${res.nome} = ${res.quant.toFixed(casasDecimais)} ${res.unidade} ${res.detalhe}\n` : `  ▪ ${res.nome}\n`;
                }
            });
            
            const commentsContainer = servicesContainer.nextElementSibling;
            const comentarios = (commentsContainer && commentsContainer.classList.contains('comentarios-container')) 
                ? processarComentarios(commentsContainer) 
                : '';

            if (comentarios) {
                if (!hasContent) {
                    const areaText = (areaInfo !== null && areaInfo > 0) ? ` | Área: ${areaInfo.toFixed(2)} m²` : '';
                    subTexto += `\n◊ ${title}${areaText}:\n`;
                }
                subTexto += comentarios;
            }
            return subTexto;
        };

        const areaPiso = parseFloat(comodoDiv.querySelector('.comodo-area-piso').value) || 0;
        const areaTeto = parseFloat(comodoDiv.querySelector('.comodo-area-teto').value) || 0;
        
        texto += processSubSection('.piso-container', 'PISO', areaPiso);
        texto += processSubSection('.teto-container', 'TETO', areaTeto);
        texto += processSubSection('.equipamentos-container', 'EQUIPAMENTOS GERAIS', null);
    });

    texto += `\n\n========================================\nQUANTITATIVOS TOTAIS PARA ORÇAMENTO\n========================================\n`;
    for (const nome in totaisGerais) {
        const item = totaisGerais[nome];
        const casasDecimais = item.unidade === 'un' ? 0 : (item.unidade === 'm³' ? 3 : 2);
        texto += `- ${nome}: ${item.total.toFixed(casasDecimais)} ${item.unidade}\n`;
    }

    return texto;
}


async function gerarPDF() {
    try {
        document.querySelectorAll('.collapsible-content, .service-collapsible-content').forEach(el => el.classList.remove('hidden'));
        document.querySelectorAll('.comentario-bloco textarea').forEach(textarea => textarea.classList.remove('hidden'));
        document.querySelectorAll('.comentario-bloco .comment-text').forEach(text => text.classList.add('hidden'));
        document.querySelectorAll('[data-action="toggle-collapse"]').forEach(btn => btn.textContent = 'Concluir Seção');
        document.querySelectorAll('[data-action="toggle-service"]').forEach(btn => btn.textContent = 'Fechar Serviço');
        document.querySelectorAll('[data-action="toggle-comment"]').forEach(btn => btn.textContent = 'Editar Comentário');
        const texto = gerarRelatorio();
        const pdf = new jsPDF('p', 'pt', 'a4');
        pdf.setFontSize(10);
        pdf.text(texto.split('\n'), 40, 40, { maxWidth: 500 });
        const nomeBeneficiario = document.getElementById('nomeBeneficiario').value || "Beneficiario";
        const nomeArquivo = `Memorial_Descritivo_${nomeBeneficiario.replace(/ /g, "_")}.pdf`;
        pdf.save(nomeArquivo);
    } catch (error) {
        alert('Erro ao gerar PDF: ' + error.message);
    }
}

function handleAppActions(e) {
    const target = e.target.closest('[data-action]');
    if (!target) return;

    e.preventDefault();
    const action = target.dataset.action;
    let container, tipos = [];

    switch (action) {
        case 'add-comodo':
            const comodoId = `comodo_${nextId++}`;
            const comodoDiv = document.createElement('div');
            comodoDiv.className = 'bloco';
            comodoDiv.id = comodoId;
            comodoDiv.setAttribute('data-bloco-type', 'comodo');
            comodoDiv.innerHTML = `
                <h3><span>Novo Cômodo</span><button class="btn-remove" data-action="remove-element" data-target-id="${comodoId}" aria-label="Remover cômodo">${REMOVE_ICON_SVG}</button></h3>
                <div class="collapsible-content">
                    <div class="campo"><label>Nome do Cômodo:</label><input type="text" class="comodo-nome" placeholder="Ex: Cozinha"></div>
                    <div class="grid-3-col">
                        <div class="campo"><label>PD Máximo (m):</label><input type="number" class="comodo-pd-max" placeholder="Ex: 2.85" min="0" step="0.01"></div>
                        <div class="campo"><label>PD Mínimo (m):</label><input type="number" class="comodo-pd-min" placeholder="Ex: 2.48" min="0" step="0.01"></div>
                    </div>
                    <h4>Paredes do Cômodo</h4>
                    <div class="paredes-container"></div>
                    <button class="btn-add btn-add-small" data-action="add-parede" aria-label="Adicionar parede ao cômodo">Adicionar Parede</button>
                    <h4>Reparo Estrutural</h4>
                    <div class="estrutural-container servicos-container"></div>
                    <div class="comentarios-container"></div>
                    <div class="botoes-acoes">
                        <button class="btn-add btn-add-small" data-action="add-servico-estrutural" aria-label="Adicionar serviço estrutural">Adicionar Serviço Estrutural</button>
                        <button class="btn-add-small" data-action="add-comentario" aria-label="Adicionar comentário">Adicionar Comentário</button>
                    </div>
                    <h4>Piso do Cômodo</h4>
                    <div class="campo"><label>Área do Piso (m²):</label><input type="number" class="comodo-area-piso" placeholder="Área exata do piso" min="0" step="0.01"></div>
                    <div class="piso-container servicos-container"></div>
                    <div class="comentarios-container"></div>
                    <div class="botoes-acoes">
                        <button class="btn-add btn-add-small" data-action="add-servico-piso" aria-label="Adicionar serviço ao piso">Adicionar Serviço ao Piso</button>
                        <button class="btn-add-small" data-action="add-comentario" aria-label="Adicionar comentário">Adicionar Comentário</button>
                    </div>
                    <h4>Teto do Cômodo</h4>
                    <div class="campo"><label>Área do Teto (m²):</label><input type="number" class="comodo-area-teto" placeholder="Área exata do teto" min="0" step="0.01"></div>
                    <div class="teto-container servicos-container"></div>
                    <div class="comentarios-container"></div>
                    <div class="botoes-acoes">
                        <button class="btn-add btn-add-small" data-action="add-servico-teto" aria-label="Adicionar serviço ao teto">Adicionar Serviço ao Teto</button>
                        <button class="btn-add-small" data-action="add-comentario" aria-label="Adicionar comentário">Adicionar Comentário</button>
                    </div>
                    <h4>Equipamentos e Instalações Gerais</h4>
                    <div class="equipamentos-container servicos-container"></div>
                    <div class="comentarios-container"></div>
                    <div class="botoes-acoes">
                        <button class="btn-add btn-add-small" data-action="add-equipamento-geral" aria-label="Adicionar equipamento geral">Adicionar Equipamento</button>
                        <button class="btn-add-small" data-action="add-comentario" aria-label="Adicionar comentário">Adicionar Comentário</button>
                    </div>
                </div>
                <button class="btn-toggle" data-action="toggle-collapse" aria-label="Concluir ou editar seção do cômodo">Concluir Seção</button>
            `;
            document.getElementById('listaComodos').appendChild(comodoDiv);
            return;
        case 'add-servico-cobertura':
            container = target.closest('.bloco').querySelector('.servicos-container');
            tipos = ['cobertura', 'cobertura_linear'];
            break;
        case 'add-parede':
            const paredesContainer = target.closest('.bloco').querySelector('.paredes-container');
            const paredeId = `parede_${nextId++}`;
            const numParedes = paredesContainer.children.length + 1;
            const paredeDiv = document.createElement('div');
            paredeDiv.className = 'parede-bloco';
            paredeDiv.id = paredeId;
            paredeDiv.innerHTML = `
                <h5><span>Parede ${numParedes}</span><button class="btn-remove" data-action="remove-element" data-target-id="${paredeId}" aria-label="Remover parede">${REMOVE_ICON_SVG}</button></h5>
                <div class="campo"><label>Comprimento da Parede (m):</label><input type="number" class="parede-comprimento" min="0" step="0.01"></div>
                <div class="servicos-container"></div>
                <div class="comentarios-container"></div>
                <div class="botoes-acoes">
                    <button class="btn-add btn-add-small" data-action="add-servico-parede" aria-label="Adicionar serviço à parede">Adicionar Serviço à Parede</button>
                    <button class="btn-add-small" data-action="add-comentario" aria-label="Adicionar comentário">Adicionar Comentário</button>
                </div>
            `;
            paredesContainer.appendChild(paredeDiv);
            return;
        case 'add-comentario':
            const comentarioContainer = target.closest('.botoes-acoes').previousElementSibling;
            if (comentarioContainer && comentarioContainer.classList.contains('comentarios-container')) {
                const comentarioId = `comentario_${nextId++}`;
                const comentarioDiv = document.createElement('div');
                comentarioDiv.className = 'comentario-bloco';
                comentarioDiv.id = comentarioId;
                comentarioDiv.innerHTML = `
                    <div class="comment-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <label style="margin-bottom: 0;">Observação:</label>
                        <div class="header-buttons">
                            <button class="btn-toggle btn-toggle-comment" data-action="toggle-comment" aria-label="Editar comentário">Editar Comentário</button>
                            <button class="btn-remove" data-action="remove-element" data-target-id="${comentarioId}" aria-label="Remover comentário">${REMOVE_ICON_SVG}</button>
                        </div>
                    </div>
                    <div class="comment-content">
                        <textarea placeholder="Digite aqui uma observação que não está na lista de serviços..."></textarea>
                        <p class="comment-text hidden"></p>
                    </div>
                    <button class="btn-finalizar hidden" data-action="finalize-comment" aria-label="Finalizar comentário">Finalizar</button>
                `;
                comentarioContainer.appendChild(comentarioDiv);
            }
            return;
        case 'add-servico-parede':
            container = target.closest('.parede-bloco').querySelector('.servicos-container');
            tipos = ['parede_area_custom', 'parede_vol_custom', 'unitario_parede'];
            break;
        case 'add-servico-piso':
            container = target.closest('.bloco').querySelector('.piso-container');
            tipos = ['piso_custom', 'piso_vol_custom', 'piso_linear', 'piso_unitario'];
            break;
        case 'add-servico-teto':
            container = target.closest('.bloco').querySelector('.teto-container');
            tipos = ['teto_custom', 'unitario_teto'];
            break;
        case 'add-servico-estrutural':
            container = target.closest('.bloco').querySelector('.estrutural-container');
            tipos = ['estrutural_area', 'estrutural_linear', 'estrutural_unitario'];
            break;
        case 'add-equipamento-geral':
            container = target.closest('.bloco').querySelector('.equipamentos-container');
            tipos = ['equipamento_geral'];
            break;
        case 'remove-element':
            const elementToRemove = document.getElementById(target.dataset.targetId);
            if (elementToRemove) elementToRemove.remove();
            return;
        case 'toggle-collapse':
            const content = target.closest('.bloco').querySelector('.collapsible-content');
            content.classList.toggle('hidden');
            target.textContent = content.classList.contains('hidden') ? 'Editar' : 'Concluir Seção';
            return;
        case 'toggle-service':
            const serviceContent = target.closest('.servico-item').querySelector('.service-collapsible-content');
            serviceContent.classList.toggle('hidden');
            target.textContent = serviceContent.classList.contains('hidden') ? 'Editar Serviço' : 'Fechar Serviço';
            return;
        case 'toggle-comment':
            const comentarioDiv = target.closest('.comentario-bloco');
            const textarea = comentarioDiv.querySelector('textarea');
            const commentText = comentarioDiv.querySelector('.comment-text');
            const finalizarBtn = comentarioDiv.querySelector('.btn-finalizar');
            if (textarea.classList.contains('hidden')) {
                textarea.classList.remove('hidden');
                commentText.classList.add('hidden');
                finalizarBtn.classList.toggle('hidden', !textarea.value.trim());
                target.textContent = 'Fechar Comentário';
            } else {
                textarea.classList.add('hidden');
                commentText.textContent = textarea.value.trim() || 'Nenhum comentário inserido';
                commentText.classList.remove('hidden');
                finalizarBtn.classList.add('hidden');
                target.textContent = 'Editar Comentário';
            }
            return;
        case 'finalize-comment':
            const comentarioDivFinalizar = target.closest('.comentario-bloco');
            const textareaFinalizar = comentarioDivFinalizar.querySelector('textarea');
            const commentTextFinalizar = comentarioDivFinalizar.querySelector('.comment-text');
            const toggleBtn = comentarioDivFinalizar.querySelector('.btn-toggle-comment');
            textareaFinalizar.classList.add('hidden');
            commentTextFinalizar.textContent = textareaFinalizar.value.trim() || 'Nenhum comentário inserido';
            commentTextFinalizar.classList.remove('hidden');
            target.classList.add('hidden');
            toggleBtn.textContent = 'Editar Comentário';
            return;
        case 'gerar-relatorio':
            if (!document.getElementById('nomeBeneficiario').value.trim()) {
                alert('ERRO: Preencha o campo "Nome Completo" do beneficiário.');
                return;
            }
            let erroDeValidacao = null;
            const todosOsServicos = document.querySelectorAll('.servico-item');
            for (const servicoDiv of todosOsServicos) {
                const select = servicoDiv.querySelector('select');
                if (!select || !select.value || select.value === 'sem_intervencao') continue;
                const servicoKey = select.value;
                const servico = SERVICOS_DB[servicoKey];
                const nomeServico = servico.nome;
                const getContexto = (el) => {
                    const parede = el.closest('.parede-bloco');
                    const comodo = el.closest('.bloco[data-bloco-type="comodo"]');
                    const cobertura = el.closest('.bloco[data-bloco-type="cobertura"]');
                    if (parede) {
                        const numParede = Array.from(parede.parentElement.children).indexOf(parede) + 1;
                        const nomeComodo = comodo.querySelector('.comodo-nome').value || 'Cômodo';
                        return `[${nomeComodo} -> Parede ${numParede}]`;
                    }
                    if (comodo) return `[${comodo.querySelector('.comodo-nome').value || 'Cômodo'}]`;
                    if (cobertura) return '[Cobertura]';
                    return '[Local não identificado]';
                };
                const contexto = getContexto(servicoDiv);
                const checkInput = (selector, fieldName) => {
                    const input = servicoDiv.querySelector(selector);
                    if (input && (input.value === '' || input.value === null || parseFloat(input.value) <= 0)) {
                        return `ERRO: Preencha o campo "${fieldName}" com um valor válido para o serviço "${nomeServico}" em ${contexto}.`;
                    }
                    return null;
                };
                const checkMainInput = (selector, fieldName, contextElement) => {
                    const input = contextElement.querySelector(selector);
                    if (input && (input.value === '' || input.value === null || parseFloat(input.value) <= 0)) {
                        return `ERRO: Preencha o campo "${fieldName}" com um valor válido em ${contexto} para calcular o serviço "${nomeServico}".`;
                    }
                    return null;
                };
                switch (servico.tipo) {
                    case 'parede_area_custom':
                    case 'estrutural_area':
                        erroDeValidacao = checkInput('[name="custom_comp"]', 'Comprimento a aplicar') || checkInput('[name=custom_larg]', 'Largura a aplicar');
                        break;
                    case 'parede_vol_custom':
                        erroDeValidacao = checkInput('[name="custom_comp"]', 'Comprimento a demolir') || checkInput('[name=custom_alt]', 'Altura a demolir') || checkInput('[name=espessura]', 'Espessura');
                        break;
                    case 'cobertura_linear':
                    case 'estrutural_linear':
                    case 'piso_linear':
                        erroDeValidacao = checkInput('[name="medida"]', 'Comprimento');
                        break;
                    case 'cobertura':
                        erroDeValidacao = checkMainInput('#areaTelhado', 'Área do Telhado', document.getElementById('bloco-cobertura'));
                        break;
                    case 'piso_custom':
                    case 'piso_vol_custom':
                        erroDeValidacao = checkMainInput('.comodo-area-piso', 'Área do Piso', servicoDiv.closest('.bloco'));
                        break;
                    case 'teto_custom':
                        erroDeValidacao = checkMainInput('.comodo-area-teto', 'Área do Teto', servicoDiv.closest('.bloco'));
                        break;
                    case 'unitario_parede':
                    case 'equipamento_geral':
                    case 'unitario_teto':
                    case 'estrutural_unitario':
                    case 'piso_unitario':
                        erroDeValidacao = checkInput('[name="quantidade"]', 'Quantidade');
                        break;
                }
                if (erroDeValidacao) break;
            }
            if (erroDeValidacao) {
                alert(erroDeValidacao);
                return;
            }

            const textoFinal = gerarRelatorio();
            document.getElementById('resumo').textContent = textoFinal;
            document.getElementById('output').style.display = 'block';
            document.getElementById('gerarPDF').style.display = 'inline-block';
            return;
        case 'gerar-pdf':
            gerarPDF();
            return;
        case 'salvar-progresso':
            salvarProgresso();
            return;
        case 'carregar-progresso':
            if (confirm('Isso irá substituir os dados atuais. Deseja carregar o último levantamento salvo?')) {
                carregarProgresso();
            }
            return;
        default:
            return;
    }

    if (container) {
        const servicoId = `servico_${nextId++}`;
        const servicoDiv = document.createElement('div');
        servicoDiv.className = 'servico-item';
        servicoDiv.id = servicoId;
        const select = document.createElement('select');
        popularSelectServicos(select, tipos);

        servicoDiv.innerHTML = `<div class="service-header"><strong></strong><div class="header-buttons"><button class="btn-remove" data-action="remove-element" data-target-id="${servicoId}" aria-label="Remover serviço">${REMOVE_ICON_SVG}</button></div></div><div class="service-collapsible-content"></div>`;
        const content = servicoDiv.querySelector('.service-collapsible-content');
        const label = document.createElement('label');
        label.textContent = 'Serviço:';
        content.appendChild(label);
        content.appendChild(select);
        content.innerHTML += `<div class="campos-especificos" style="margin-top:10px;"></div>`;
        container.appendChild(servicoDiv);
    }
}

document.addEventListener('input', (e) => {
    const target = e.target;
    const servicoDiv = target.closest('.servico-item');
    const comentarioDiv = target.closest('.comentario-bloco');
    if (servicoDiv) {
        if (target.matches('[name="custom_comp"], [name="custom_larg"]')) {
            const comp = parseFloat(servicoDiv.querySelector('[name="custom_comp"]')?.value) || 0;
            const larg = parseFloat(servicoDiv.querySelector('[name="custom_larg"]')?.value) || 0;
            const totalSpan = servicoDiv.querySelector('.area-total');
            if (totalSpan) totalSpan.textContent = (comp * larg).toFixed(2);
        }
        if (target.matches('[name="custom_comp"], [name="custom_alt"]')) {
            const comp = parseFloat(servicoDiv.querySelector('[name="custom_comp"]')?.value) || 0;
            const alt = parseFloat(servicoDiv.querySelector('[name="custom_alt"]')?.value) || 0;
            const totalSpan = servicoDiv.querySelector('.area-total');
            if (totalSpan) totalSpan.textContent = (comp * alt).toFixed(2);
        }
        if (target.matches('[name="custom_comp"], [name="custom_alt"], [name="espessura"]')) {
            const comp = parseFloat(servicoDiv.querySelector('[name="custom_comp"]')?.value) || 0;
            const alt = parseFloat(servicoDiv.querySelector('[name="custom_alt"]')?.value) || 0;
            const esp = parseFloat(servicoDiv.querySelector('[name="espessura"]')?.value) || 0;
            const totalSpan = servicoDiv.querySelector('.vol-total');
            if (totalSpan) totalSpan.textContent = (comp * alt * esp).toFixed(3);
        }
    }
    if (comentarioDiv && target.matches('textarea')) {
        const finalizarBtn = comentarioDiv.querySelector('.btn-finalizar');
        finalizarBtn.classList.toggle('hidden', !target.value.trim());
    }
});

document.addEventListener('change', (e) => {
    const target = e.target;
    if (target.matches('select')) {
        const servicoDiv = target.closest('.servico-item');
        if (servicoDiv) {
            gerarCamposServico(servicoDiv, target.value);
            const header = servicoDiv.querySelector('.service-header');
            const servicoId = servicoDiv.id;

            if (target.value) {
                const serviceName = (target.value === 'sem_intervencao') ? 'Sem intervenção' : target.options[target.selectedIndex].text;
                header.innerHTML = `<div class="service-header"><strong>${serviceName}</strong><div class="header-buttons"><button class="btn-toggle-service" data-action="toggle-service" aria-label="Alternar visibilidade do serviço">Fechar Serviço</button><button class="btn-remove" data-action="remove-element" data-target-id="${servicoId}" aria-label="Remover serviço">${REMOVE_ICON_SVG}</button></div></div>`;
            } else {
                header.innerHTML = `<div class="service-header"><strong></strong><div class="header-buttons"><button class="btn-remove" data-action="remove-element" data-target-id="${servicoId}" aria-label="Remover serviço">${REMOVE_ICON_SVG}</button></div></div>`;
            }
        }
    }
});

['click', 'touchend'].forEach(evt => {
    document.addEventListener(evt, handleAppActions);
});

// FUNÇÕES DE SALVAR/CARREGAR
function extrairDados(container) {
    const servicos = [];
    container.querySelectorAll('.servico-item').forEach(servicoDiv => {
        const select = servicoDiv.querySelector('select');
        if (select && select.value) {
            const servico = {
                id: select.value,
                campos: {}
            };
            servicoDiv.querySelectorAll('.campos-especificos input, .campos-especificos select').forEach(input => {
                servico.campos[input.name] = input.value;
            });
            servicos.push(servico);
        }
    });

    const comentarios = [];
    container.querySelectorAll('.comentario-bloco textarea').forEach(textarea => {
        comentarios.push(textarea.value);
    });

    return { servicos, comentarios };
}

function salvarProgresso(silencioso = false) {
    const dados = {
        beneficiario: {
            nome: document.getElementById('nomeBeneficiario').value,
            endereco: document.getElementById('enderecoBeneficiario').value
        },
        responsavel: {
            nome: document.getElementById('nomeResponsavel').value
        },
        cobertura: {
            area: document.getElementById('areaTelhado').value,
            pdMax: document.getElementById('pdMaximo').value,
            pdMin: document.getElementById('pdMinimo').value,
            ...extrairDados(document.getElementById('bloco-cobertura'))
        },
        comodos: []
    };

    document.querySelectorAll('#listaComodos .bloco').forEach(comodoDiv => {
        const comodo = {
            nome: comodoDiv.querySelector('.comodo-nome').value,
            pdMax: comodoDiv.querySelector('.comodo-pd-max').value,
            pdMin: comodoDiv.querySelector('.comodo-pd-min').value,
            areaPiso: comodoDiv.querySelector('.comodo-area-piso').value,
            areaTeto: comodoDiv.querySelector('.comodo-area-teto').value,
            paredes: [],
            estrutural: extrairDados(comodoDiv.querySelector('.estrutural-container').parentElement),
            piso: extrairDados(comodoDiv.querySelector('.piso-container').parentElement),
            teto: extrairDados(comodoDiv.querySelector('.teto-container').parentElement),
            equipamentos: extrairDados(comodoDiv.querySelector('.equipamentos-container').parentElement)
        };
        comodoDiv.querySelectorAll('.parede-bloco').forEach(paredeDiv => {
            comodo.paredes.push({
                comprimento: paredeDiv.querySelector('.parede-comprimento').value,
                ...extrairDados(paredeDiv)
            });
        });
        dados.comodos.push(comodo);
    });

    localStorage.setItem(STORAGE_KEY, JSON.stringify(dados));
    
    if (!silencioso) {
        const status = document.getElementById('saveStatus');
        const hora = new Date().toLocaleTimeString();
        status.textContent = `Salvo às ${hora}`;
        status.style.opacity = '1';
        setTimeout(() => { status.style.opacity = '0'; }, 2000);
    }
}

function carregarProgresso() {
    const dadosSalvos = localStorage.getItem(STORAGE_KEY);
    if (!dadosSalvos) {
        alert('Nenhum progresso salvo encontrado.');
        return;
    }

    const dados = JSON.parse(dadosSalvos);

    // Limpa o formulário atual
    document.getElementById('listaComodos').innerHTML = '';
    document.getElementById('bloco-cobertura').querySelector('.servicos-container').innerHTML = '';
    document.getElementById('bloco-cobertura').querySelector('.comentarios-container').innerHTML = '';


    // Preenche dados gerais
    document.getElementById('nomeBeneficiario').value = dados.beneficiario.nome;
    document.getElementById('enderecoBeneficiario').value = dados.beneficiario.endereco;
    document.getElementById('nomeResponsavel').value = dados.responsavel.nome;
    
    // Preenche Cobertura
    const cobertura = dados.cobertura;
    document.getElementById('areaTelhado').value = cobertura.area;
    document.getElementById('pdMaximo').value = cobertura.pdMax;
    document.getElementById('pdMinimo').value = cobertura.pdMin;
    recriarItens(document.querySelector('#bloco-cobertura [data-action="add-servico-cobertura"]'), cobertura.servicos);
    recriarItens(document.querySelector('#bloco-cobertura [data-action="add-comentario"]'), cobertura.comentarios);

    // Preenche Cômodos
    dados.comodos.forEach(comodoData => {
        document.getElementById('addComodo').click();
        const novoComodo = document.querySelector('#listaComodos .bloco:last-child');
        
        novoComodo.querySelector('.comodo-nome').value = comodoData.nome;
        novoComodo.querySelector('.comodo-pd-max').value = comodoData.pdMax;
        novoComodo.querySelector('.comodo-pd-min').value = comodoData.pdMin;
        novoComodo.querySelector('.comodo-area-piso').value = comodoData.areaPiso;
        novoComodo.querySelector('.comodo-area-teto').value = comodoData.areaTeto;

        comodoData.paredes.forEach(paredeData => {
            novoComodo.querySelector('[data-action="add-parede"]').click();
            const novaParede = novoComodo.querySelector('.parede-bloco:last-child');
            novaParede.querySelector('.parede-comprimento').value = paredeData.comprimento;
            recriarItens(novaParede.querySelector('[data-action="add-servico-parede"]'), paredeData.servicos);
            recriarItens(novaParede.querySelector('[data-action="add-comentario"]'), paredeData.comentarios);
        });

        recriarItens(novoComodo.querySelector('[data-action="add-servico-estrutural"]'), comodoData.estrutural.servicos);
        recriarItens(novoComodo.querySelector('[data-action="add-comentario"]', novoComodo.querySelector('.estrutural-container').parentElement), comodoData.estrutural.comentarios);
        recriarItens(novoComodo.querySelector('[data-action="add-servico-piso"]'), comodoData.piso.servicos);
        recriarItens(novoComodo.querySelector('[data-action="add-comentario"]', novoComodo.querySelector('.piso-container').parentElement), comodoData.piso.comentarios);
        recriarItens(novoComodo.querySelector('[data-action="add-servico-teto"]'), comodoData.teto.servicos);
        recriarItens(novoComodo.querySelector('[data-action="add-comentario"]', novoComodo.querySelector('.teto-container').parentElement), comodoData.teto.comentarios);
        recriarItens(novoComodo.querySelector('[data-action="add-equipamento-geral"]'), comodoData.equipamentos.servicos);
        recriarItens(novoComodo.querySelector('[data-action="add-comentario"]', novoComodo.querySelector('.equipamentos-container').parentElement), comodoData.equipamentos.comentarios);
    });

    alert('Progresso carregado com sucesso!');
}

function recriarItens(botaoAdd, itens) {
    if (!itens || itens.length === 0) return;

    const isServico = botaoAdd.dataset.action.includes('servico') || botaoAdd.dataset.action.includes('equipamento');

    itens.forEach(itemData => {
        botaoAdd.click();
        const container = botaoAdd.closest('.botoes-acoes').previousElementSibling;
        const novoItem = container.lastElementChild;

        if (isServico) {
            const select = novoItem.querySelector('select');
            select.value = itemData.id;
            select.dispatchEvent(new Event('change')); // Dispara o evento para criar os campos
            for (const [key, value] of Object.entries(itemData.campos)) {
                const campo = novoItem.querySelector(`[name="${key}"]`);
                if (campo) campo.value = value;
            }
        } else { // É comentário
            novoItem.querySelector('textarea').value = itemData;
        }
    });
}


// INICIALIZAÇÃO
document.addEventListener('DOMContentLoaded', () => {
    if (localStorage.getItem(STORAGE_KEY)) {
        if (confirm('Foi encontrado um levantamento salvo. Deseja restaurar o progresso?')) {
            carregarProgresso();
        }
    }
    setInterval(() => salvarProgresso(true), 30000); 
});

// LÓGICA DO TEMA
const themeToggle = document.getElementById('theme-toggle');
const htmlElement = document.documentElement;

themeToggle.addEventListener('click', () => {
    htmlElement.classList.toggle('dark-mode');
    if (htmlElement.classList.contains('dark-mode')) {
        localStorage.setItem('theme', 'dark');
    } else {
        localStorage.setItem('theme', 'light');
    }
});

</script>
</body>
</html>