<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Levantamento Habitacional v20.3</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; margin: 0; padding: 0; background-color: #f8f9fa; color: #212529; }
        .container { max-width: 900px; margin: 20px auto; background-color: #ffffff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        h1, h2, h3, h4, h5 { color: #0056b3; border-bottom: 2px solid #e9ecef; padding-bottom: 8px; }
        h4 { margin-top: 30px; }
        h3, h5 { display: flex; justify-content: space-between; align-items: center; }
        .bloco { border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 25px; background-color: #fff; }
        .parede-bloco, .piso-bloco { border: 1px solid #ced4da; border-radius: 5px; padding: 15px; margin-top: 15px; background-color: #f8f9fa; }
        .campo { margin-bottom: 15px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; color: #495057; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        button { background-color: #0056b3; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 10px; transition: background-color 0.2s; }
        button:hover { background-color: #004494; }
        .btn-add { background-color: #28a745; }
        .btn-add:hover { background-color: #218838; }
        .btn-pdf { background-color: #c82333; }
        .btn-pdf:hover { background-color: #a21b29; }
        .btn-toggle, .btn-toggle-service { background-color: #ffc107; color: black; font-size: 14px; padding: 8px 12px; }
        .btn-toggle:hover, .btn-toggle-service:hover { background-color: #e0a800; }
        .btn-add-small { font-size: 14px; padding: 8px 12px; margin-top: 5px; }
        
        .btn-remove {
            background: transparent;
            border: none;
            color: #6c757d;
            padding: 5px;
            margin: 0;
            margin-left: 10px;
            cursor: pointer;
            line-height: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s, color 0.2s;
        }
        .btn-remove svg {
            width: 18px;
            height: 18px;
        }
        .btn-remove:hover {
            color: #dc3545;
            background-color: #f1f1f1;
        }
        
        #resumo-container { background-color: #e9ecef; border-left: 5px solid #0056b3; margin-top: 20px; padding: 20px; border-radius: 5px; font-family: "SFMono-Regular", Menlo, Monaco, Consolas, monospace; font-size: 14px; }
        #resumo { white-space: pre-wrap; word-wrap: break-word; }
        .grid-3-col { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .hidden { display: none; }
        .servico-item { padding: 15px; border: 1px solid #e9ecef; border-radius: 4px; margin-top: 10px; }
        
        .service-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }
        .service-header strong { font-size: 1.1em; flex-grow: 1; }
        .header-buttons { display: flex; align-items: center; flex-shrink: 0; }

        footer { text-align: center; padding: 20px; margin-top: 40px; border-top: 1px solid #dee2e6; font-size: 14px; color: #6c757d; }
        footer a { color: #0056b3; text-decoration: none; font-weight: 600; }
        footer a:hover { text-decoration: underline; }
    </style>
</head>
<body>

<div class="container">
    <h1>Ferramenta de Levantamento v20.3</h1>
    <div class="bloco">
        <h2>Dados do Beneficiário</h2>
          <div class="collapsible-content">
              <div class="campo"><label for="nomeBeneficiario">Nome Completo:</label><input type="text" id="nomeBeneficiario"></div>
              <div class="campo"><label for="enderecoBeneficiario">Endereço:</label><input type="text" id="enderecoBeneficiario"></div>
          </div>
    </div>
    <div class="bloco">
        <h2>Dados do Responsável Técnico</h2>
        <div class="campo">
            <label for="nomeResponsavel">Nome do Responsável Técnico:</label>
            <input type="text" id="nomeResponsavel" placeholder="Digite o nome do técnico">
        </div>
    </div>
    <div id="bloco-cobertura" class="bloco" data-bloco-type="cobertura">
        <h2>Cobertura</h2>
        <div class="collapsible-content">
            <div class="grid-3-col">
                <div class="campo">
                    <label for="areaTelhado">Área do Telhado (m²):</label>
                    <input type="number" id="areaTelhado" placeholder="Ex: 55.5">
                </div>
                <div class="campo">
                    <label for="pdMaximo">PD Máximo (m):</label>
                    <input type="number" id="pdMaximo" placeholder="Ex: 2.80">
                </div>
                <div class="campo">
                    <label for="pdMinimo">PD Mínimo (m):</label>
                    <input type="number" id="pdMinimo" placeholder="Ex: 2.50">
                </div>
            </div>
            <div class="servicos-container"></div>
            <button class="btn-add btn-add-small" data-action="add-servico-cobertura">Adicionar Serviço à Cobertura</button>
        </div>
        <button class="btn-toggle" data-action="toggle-collapse">Concluir Seção</button>
    </div>
    <h2>Cômodos e Intervenções</h2>
    <div id="listaComodos"></div>
    <button id="addComodo" class="btn-add" data-action="add-comodo">Adicionar Cômodo</button>
    
    <hr style="margin: 30px 0;">
    
    <button id="gerarResumo" data-action="gerar-relatorio">Gerar Relatório de Texto</button>
    <button id="gerarPDF" class="btn-pdf" style="display:none;" data-action="gerar-pdf">Gerar PDF</button>
    <button id="salvarRascunho" data-action="salvar-rascunho" style="background-color: #17a2b8;">Salvar Rascunho</button>
    <button id="carregarRascunho" data-action="carregar-rascunho" style="background-color: #6c757d;">Carregar Rascunho</button>

    <div id="output" style="display:none; margin-top: 20px;">
        <h3>Relatório Final</h3>
        <div id="resumo-container">
            <pre id="resumo"></pre>
        </div>
    </div>
    <footer>
        Desenvolvido por 
        <a href="https://github.com/menezesdouglas" target="_blank" rel="noopener noreferrer">Douglas Menezes</a> 
        & 
        <a href="https://github.com/vitoriamignon" target="_blank" rel="noopener noreferrer">Vitoria Mignon</a>
    </footer>
</div>

<script>
const REMOVE_ICON_SVG = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>`;

window.jsPDF = window.jspdf.jsPDF;
let nextId = 0;

const SERVICOS_DB = {
    // ===== COBERTURA =====
    "estrutura_madeira_cobertura": { nome: "Estrutura em madeira para cobertura", unidade: "m²", tipo: "cobertura" },
    "remocao_telha_francesa_ex_madeiramento": { nome: "Remoção de cobertura em telhas francesas (exclusivo madeiramento)", unidade: "m²", tipo: "cobertura" },
    "remocao_telha_francesa_inclusive": { nome: "Remoção de cobertura em telhas francesas (inclusive)", unidade: "m²", tipo: "cobertura" },
    "retirada_recolocacao_telhas_francesas": { nome: "Retirada e recolocação de telhas francesas (inclusive)", unidade: "m²", tipo: "cobertura" },
    "cumeeira_recolocacao": { nome: "Cumeeira (exclusive fornecimento de material novo)", unidade: "m²", tipo: "cobertura" },
    "retirada_recolocacao_madeiramento": { nome: "Retirada e recolocação de madeiramento (telhas francesas/coloniais)", unidade: "m²", tipo: "cobertura" },
    "trama_madeira_completa": { nome: "Trama de madeira (ripas, caibros, terças) para telhados de até 2 águas", unidade: "m²", tipo: "cobertura" },
    "cobertura_telha_ceramica_francesa": { nome: "Cobertura em telha ceramica francesa (exclusive cumeeira e madeiramento)", unidade: "m²", tipo: "cobertura" },
    "remocao_cobertura_fibrocimento_ex_madeiramento": { nome: "Remoção de cobertura de fibrocimento (exclusive madeiramento)", unidade: "m²", tipo: "cobertura" },
    "retirada_recolocacao_madeiramento_fibrocimento": { nome: "Retirada e recolocação de madeiramento (telhas fibrocimento)", unidade: "m²", tipo: "cobertura" },
    "remocao_cobertura_fibrocimento_inclusive": { nome: "Remoção de cobertura de fibrocimento (inclusive madeiramento)", unidade: "m²", tipo: "cobertura" },
    "madeiramento_cobertura_onduladas": { nome: "Madeiramento para cobertura em telhas onduladas", unidade: "m²", tipo: "cobertura" },
    "cobertura_telhas_crfs_6mm": { nome: "Cobertura em telhas de cimento CRFS 6mm (sem amianto)", unidade: "m²", tipo: "cobertura" },
    "beiral_fibrocimento_60cm": { nome: "Beiral de telhas onduladas de fibrocimento 6mm, projeção 60cm", unidade: "m", tipo: "cobertura_linear" },
    "beiral_fibrocimento_120cm": { nome: "Beiral de telhas onduladas de fibrocimento 6mm, projeção 120cm", unidade: "m", tipo: "cobertura_linear" },
    "calha_beiral_pvc_dn125": { nome: "Calha de beiral semi-circular de PVC, DN 125", unidade: "m", tipo: "cobertura_linear" },
    "condutor_circular_pvc_dn88": { nome: "Condutor circular para calha de beiral de PVC, DN 88", unidade: "m", tipo: "cobertura_linear" },
    "caibro_madeira_3x1_5": { nome: "Caibro de madeira serrada 3\"x1.1/2\"", unidade: "m", tipo: "cobertura_linear" },
    "ripa_madeira_1_5x4cm": { nome: "Ripa de madeira serrada 1,5x4cm", unidade: "m", tipo: "cobertura_linear" },
    "terca_madeira_3x3": { nome: "Terça de madeira serrada 3\"x3\"", unidade: "m", tipo: "cobertura_linear" },
    "terca_madeira_aparelhada_3x4_5": { nome: "Terça de madeira aparelhada 3\"x4.1/2\"", unidade: "m", tipo: "cobertura_linear" },

    // ===== SERVIÇOS DE PAREDE =====
    "remocao_revestimento_parede": { nome: "Remoção de revestimento de parede", unidade: "m²", tipo: "parede_area_custom" },
    "alvenaria_vedacao": { nome: "Alvenaria de vedação", unidade: "m²", tipo: "parede_area_custom" },
    "corte_impermeabilizacao": { nome: "Corte e impermeabilização de parede", unidade: "m²", tipo: "parede_area_custom" },
    "embozo_parede": { nome: "Emboço paulista em paredes", unidade: "m²", tipo: "parede_area_custom" },
    "revestimento_ceramico_parede": { nome: "Revestimento cerâmico em paredes", unidade: "m²", tipo: "parede_area_custom" },
    "pintura_pva": { nome: "Preparo e pintura com tinta PVA látex", unidade: "m²", tipo: "parede_area_custom" },
    "demolicao_alvenaria": { nome: "Demolição de alvenaria c/ emboço", unidade: "m³", tipo: "parede_vol_custom" },
    "arrancamento_porta": { nome: "Arrancamento de porta de madeira", unidade: "un", tipo: "unitario_parede" },
    "arrancamento_janela": { nome: "Arrancamento de janela", unidade: "un", tipo: "unitario_parede" },
    "porta_madeira": { nome: "Porta de madeira semi-oca", unidade: "un", tipo: "unitario_parede" },
    "janela_aluminio_120x100": { nome: "Janela de correr em alumínio (1,20x1,00m)", unidade: "un", tipo: "unitario_parede" },
    "janela_aluminio_100x60": { nome: "Janela basculante alumínio (1,00x0,60m)", unidade: "un", tipo: "unitario_parede" },
    "ponto_agua_fria": { nome: "Ponto de água fria", unidade: "un", tipo: "unitario_parede" },
    "ponto_esgoto": { nome: "Ponto de esgoto", unidade: "un", tipo: "unitario_parede" },
    "ponto_tomada": { nome: "Ponto de tomada", unidade: "un", tipo: "unitario_parede" },
    "vaso_sanitario_parede": { nome: "Vaso sanitário com caixa acoplada", unidade: "un", tipo: "unitario_parede" },
    "tanque_louca_parede": { nome: "Tanque de louça", unidade: "un", tipo: "unitario_parede" },

    // ===== SERVIÇOS DE PISO (ATUALIZADO) =====
    "enchimento_piso_concreto": { nome: "ENCHIMENTO DE PISO COM ESCOMBRO DAS PROPRIAS EDIFICACOES, ATE UMA ALTURA MAXIMA DE 80CM", unidade: "M3", tipo: "piso_vol_custom" },
    "demolicao_piso_ladrilho": { nome: "DEMOLICAO DE PISO DE LADRILHO COM RESPECTIVA CAMADA DE ARGAMASSA DE ASSENTAMENTO", unidade: "M2", tipo: "piso_custom" },
    "demolicao_manual_piso_cimentado": { nome: "DEMOLICAO MANUAL DE PISO CIMENTADO E DA RESPECTIVA BASE DE CONCRETO", unidade: "M2", tipo: "piso_custom" },
    "piso_cimentado_1_5cm": { nome: "PISO CIMENTADO,COM 1,5CM DE ESPESSURA,COM ARGAMASSA DE CIMENTO E AREIA,NO TRACO 1:3", unidade: "M2", tipo: "piso_custom" },
    "contrapiso_regularizadora_1_5cm": { nome: "CONTRAPISO,BASE OU CAMADA REGULARIZADORA,EXECUTADA COM ARGAMASSA DE CIMENTO A AREIA,NO TRACO 1:4,NA ESPESSURA DE 1,5CM", unidade: "M2", tipo: "piso_custom" },
    "contrapiso_regularizadora_5cm": { nome: "CONTRAPISO,BASE OU CAMADA REGULARIZADORA,EXECUTADA COM ARGAMASSA DE CIMENTO E AREIA,NO TRACO 1:4,NA ESPESSURA DE 5CM", unidade: "M2", tipo: "piso_custom" },
    "revestimento_ceramico_antiderrapante_45x45": { nome: "REVESTIMENTO DE PISO COM LADRILHO CERAMICO,ANTIDERRAPANTE,MEDIDAS EM TORNO DE (45x45)CM", unidade: "M2", tipo: "piso_custom" },
    "soleira_granito_cinza_andorinha_2cm_15_18cm": { nome: "SOLEIRA EM GRANITO CINZA ANDORINHA,ESPESSURA DE 2CM, LARGURA15 A 18CM", unidade: "M", tipo: "piso_linear" },
    "soleira_granito_cinza_andorinha_2cm_20_22cm": { nome: "SOLEIRA EM GRANITO CINZA ANDORINHA,ESPESSURA DE 2CM,COM 2 POLIMENTOS, LARGURA DE 20-22CM", unidade: "M", tipo: "piso_linear" },
    "pedra_box_banheiro_granito_tento_5cm": { nome: "PEDRA PARA BOX DE BANHEIRO EM GRANITO (TENTO), SEM REBAIXO, COM 5CM DE ALTURA", unidade: "M", tipo: "piso_linear" },
    "rodape_ladrilho_ceramico_7_10cm": { nome: "RODAPE COM LADRILHO CERAMICO,COM 7,5 A 10CM DE ALTURA", unidade: "M", tipo: "piso_linear" },
    "peitoril_granito_cinza_andorinha_2cm_15_18cm": { nome: "PEITORIL EM GRANITO CINZA ANDORINHA,ESPESSURA DE 2CM,LARGURA15 A 18CM", unidade: "M", tipo: "piso_linear" },
    "soleira_granito_cinza_andorinha_2cm_15_20cm": { nome: "SOLEIRA EM GRANITO CINZA ANDORINHA,ESPESSURA DE 2CM,COM 2 POLIMENTOS, LARGURA DE 15-20CM", unidade: "M", tipo: "piso_linear" },
    "pedra_box_banheiro_granito_tento_reto_5cm": { nome: "PEDRA PARA BOX DE BANHEIRO EM GRANITO (TENTO), SEM REBAIXO, COM 5CM DE ALTURA, ASSENTE COMO EM 13.045.0040", unidade: "M", tipo: "piso_linear" },
    "aterramento_completo": { nome: "ATERRAMENTO COMPOSTO POR 1 CAIXA 25X25CM, 1 HASTE DE COBRE 5/8\", 1 CONECTOR, 6M DE CABO", unidade: "UN", tipo: "piso_unitario" },

    // ===== SERVIÇOS DE TETO =====
    "remocao_forro_estuque_gesso": { nome: "Remoção de forro de estuque, gesso, placas prensadas", unidade: "m²", tipo: "teto_custom" },
    "remocao_forro_lambri_madeira_pvc": { nome: "Remoção de forro ou lambri de madeira ou PVC", unidade: "m²", tipo: "teto_custom" },
    "forro_pvc_reguas_200mm": { nome: "Forro de PVC em réguas de 200mm (inclusive estrutura)", unidade: "m²", tipo: "teto_custom" },
    "instalacao_ponto_luz_2varas": { nome: "Instalação de ponto de luz (equiv. 2 varas de eletroduto)", unidade: "un", tipo: "unitario_teto" },
    "instalacao_conjunto_2pontos_luz": { nome: "Instalação de conjunto de 2 pontos de luz (equiv. 5 varas)", unidade: "un", tipo: "unitario_teto" },
    "instalacao_conjunto_3pontos_luz": { nome: "Instalação de conjunto de 3 pontos de luz (equiv. 6 varas)", unidade: "un", tipo: "unitario_teto" },
    "lampada_led_bulbo_a60": { nome: "Lâmpada LED, bulbo, A60, 8W", unidade: "un", tipo: "unitario_teto" },
    "globo_esferico_plafonier": { nome: "Globo esférico 10x15cm e plafonier em alumínio", unidade: "un", tipo: "unitario_teto" },
    
    // ===== REPARO ESTRUTURAL =====
    "reparacao_estrutural_geral": { nome: "Reparação estrutural (remoção, limpeza, tratamento, recomposição)", unidade: "m²", tipo: "estrutural_area" },
    "concreto_baldrames_15x40": { nome: "Formas, armaduras e concreto para baldrames 15x40cm", unidade: "m", tipo: "estrutural_linear" },
    "concreto_sapata_60x60x30": { nome: "Formas, armaduras e concreto para sapata 60x60x30cm", unidade: "un", tipo: "estrutural_unitario" },
    "concreto_laje_h12": { nome: "Formas, armaduras e concreto para laje h=12cm", unidade: "m²", tipo: "estrutural_area" },
    "concreto_pilares_vigas_cintas_15x30": { nome: "Formas, armaduras e concreto para pilares/vigas/cintas 15x30cm", unidade: "m", tipo: "estrutural_linear" },

    // ===== EQUIPAMENTOS GERAIS =====
    "caixa_agua_1000l": { nome: "Caixa d'água de polietileno 1000L", unidade: "un", tipo: "equipamento_geral" },
};

function popularSelectServicos(selectElement, tiposFiltro) {
    selectElement.innerHTML = `
        <option value="">-- Escolha um serviço --</option>
        <option value="sem_intervencao">Sem intervenção</option>
    `;
    tiposFiltro.forEach(tipo => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = tipo.replace(/_/g, ' ').toUpperCase();
        for (const key in SERVICOS_DB) {
            if (SERVICOS_DB[key].tipo === tipo) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = SERVICOS_DB[key].nome;
                optgroup.appendChild(option);
            }
        }
        if (optgroup.children.length > 0) selectElement.appendChild(optgroup);
    });
}

function gerarCamposServico(servicoDiv, servicoKey) {
    const camposDiv = servicoDiv.querySelector('.campos-especificos');
    if (!servicoKey || servicoKey === 'sem_intervencao') { 
        camposDiv.innerHTML = ''; 
        return; 
    }
    camposDiv.innerHTML = ''; 

    const servico = SERVICOS_DB[servicoKey];
    let html = '';

    switch (servico.tipo) {
        case 'parede_area_custom':
        case 'estrutural_area':
            html = `<p>Informe as medidas exatas da área de aplicação:</p>
                        <div class="campo"><label>Comprimento a aplicar (m):</label><input type="number" name="custom_comp" placeholder="Ex: 3.21"></div>
                        <div class="campo"><label>Largura a aplicar (m):</label><input type="number" name="custom_larg" placeholder="Ex: 0.50"></div>
                        <p><b>Área calculada: <span class="area-total">0.00</span> m²</b></p>`;
            break;
        case 'parede_vol_custom':
            html = `<p>Informe as medidas exatas da área a ser demolida:</p>
                        <div class="campo"><label>Comprimento a demolir (m):</label><input type="number" name="custom_comp" placeholder="Ex: 0.80"></div>
                        <div class="campo"><label>Altura a demolir (m):</label><input type="number" name="custom_alt" placeholder="Ex: 2.10"></div>
                        <div class="campo"><label>Espessura (m):</label><input type="number" name="espessura" value="0.15"></div>
                        <p><b>Volume de demolição: <span class="vol-total">0.000</span> m³</b></p>`;
            break;
        case 'piso_custom': 
             html = `<p>O cálculo usará a área do piso informada para o cômodo.</p>`; 
             break;
        case 'piso_vol_custom': 
            html = `<div class="campo"><label>Espessura (m):</label><input type="number" name="espessura" value="0.05"></div><p>O cálculo usará a área do piso informada.</p>`; 
            break;
        case 'teto_custom':
             html = `<p>O cálculo usará a área do teto informada para o cômodo.</p>`; 
             break;
        case 'cobertura': html = `<p>O cálculo usará a área do telhado informada.</p>`; break;
        case 'cobertura_linear':
        case 'estrutural_linear':
        case 'piso_linear':
            html = `<div class="campo"><label>Comprimento (m):</label><input type="number" name="medida"></div>`; break;
        case 'unitario_parede':
        case 'equipamento_geral':
        case 'unitario_teto':
        case 'estrutural_unitario':
        case 'piso_unitario':
            html = `<div class="campo"><label>Quantidade:</label><input type="number" name="quantidade" value="1" step="1"></div>`; break;
    }
    camposDiv.innerHTML = html;
}

function gerarRelatorio() {
    let texto = `MEMORIAL DESCRITIVO\n\n`;
    texto += `BENEFICIÁRIO(A): ${document.getElementById('nomeBeneficiario').value}\n`;
    texto += `ENDEREÇO: ${document.getElementById('enderecoBeneficiario').value}\n`;
    texto += `RESPONSÁVEL TÉCNICO: ${document.getElementById('nomeResponsavel').value}\n`;
    const totaisGerais = {};

    const processarServico = (servicoDiv) => {
        const select = servicoDiv.querySelector('select');
        const servicoKey = select?.value;

        if (!servicoKey) return null;

        if (servicoKey === 'sem_intervencao') {
            return { nome: "Sem intervenção", isIntervention: false };
        }

        const servico = SERVICOS_DB[servicoKey];
        let quant = 0, detalhe = '';
        
        const getVal = (selector, parent) => parent ? parseFloat(parent.querySelector(selector)?.value) || 0 : 0;
        
        const comodoDiv = servicoDiv.closest('.bloco[data-bloco-type="comodo"]');
        const coberturaDiv = servicoDiv.closest('.bloco[data-bloco-type="cobertura"]');

        switch (servico.tipo) {
            case 'cobertura': quant = getVal('#areaTelhado', coberturaDiv); break;
            case 'cobertura_linear': 
            case 'estrutural_linear':
            case 'piso_linear':
                quant = getVal('[name=medida]', servicoDiv); 
                break;
            case 'parede_area_custom':
                const customCompArea = getVal('[name=custom_comp]', servicoDiv);
                const customAltArea = getVal('[name=custom_alt]', servicoDiv);
                quant = customCompArea * customAltArea;
                detalhe = `(${customCompArea.toFixed(2)}m x ${customAltArea.toFixed(2)}m)`;
                break;
            case 'estrutural_area':
                const compEstrutural = getVal('[name=custom_comp]', servicoDiv);
                const largEstrutural = getVal('[name=custom_larg]', servicoDiv);
                quant = compEstrutural * largEstrutural;
                detalhe = `(${compEstrutural.toFixed(2)}m x ${largEstrutural.toFixed(2)}m)`;
                break;
            case 'parede_vol_custom':
                const customCompVol = getVal('[name=custom_comp]', servicoDiv);
                const customAltVol = getVal('[name=custom_alt]', servicoDiv);
                const esp = getVal('[name=espessura]', servicoDiv);
                quant = customCompVol * customAltVol * esp;
                detalhe = `(${customCompVol.toFixed(2)}m x ${customAltVol.toFixed(2)}m x ${esp.toFixed(2)}m)`;
                break;
            case 'piso_custom': 
                quant = getVal('.comodo-area-piso', comodoDiv); break;
            case 'piso_vol_custom':
                 const areaPiso = getVal('.comodo-area-piso', comodoDiv);
                 const espVol = getVal('[name=espessura]', servicoDiv);
                 quant = areaPiso * espVol; detalhe = `(${areaPiso.toFixed(2)}m² x ${espVol.toFixed(2)}m)`;
                break;
            case 'teto_custom':
                quant = getVal('.comodo-area-teto', comodoDiv); break;
            case 'unitario_parede':
            case 'equipamento_geral':
            case 'unitario_teto':
            case 'estrutural_unitario':
            case 'piso_unitario':
                quant = parseInt(getVal('[name=quantidade]', servicoDiv)) || 0; break;
        }

        if (quant > 0) {
            if (!totaisGerais[servico.nome]) totaisGerais[servico.nome] = { total: 0, unidade: servico.unidade };
            totaisGerais[servico.nome].total += quant;
            return { nome: servico.nome, quant: quant, unidade: servico.unidade, detalhe, isIntervention: true };
        }
        return null;
    };

    const areaTelhado = parseFloat(document.getElementById('areaTelhado').value) || 0;
    const pdMax = parseFloat(document.getElementById('pdMaximo').value) || 0;
    const pdMin = parseFloat(document.getElementById('pdMinimo').value) || 0;
    texto += `\n----------------------------------------\nCOBERTURA | Área: ${areaTelhado.toFixed(2)} m² | PD Máx: ${pdMax.toFixed(2)}m | PD Mín: ${pdMin.toFixed(2)}m\n----------------------------------------\n`;
    document.querySelectorAll('#bloco-cobertura .servico-item').forEach(servicoDiv => {
        const res = processarServico(servicoDiv);
        if (res) {
            if (res.isIntervention) {
                 texto += `▪ ${res.nome} = ${res.quant.toFixed(2)} ${res.unidade}\n`;
            } else {
                 texto += `▪ ${res.nome}\n`;
            }
        }
    });

    document.querySelectorAll('#listaComodos > .bloco').forEach(comodoDiv => {
        const nome = comodoDiv.querySelector('.comodo-nome').value || "Cômodo";
        const pdMaxComodo = parseFloat(comodoDiv.querySelector('.comodo-pd-max').value) || 0;
        const pdMinComodo = parseFloat(comodoDiv.querySelector('.comodo-pd-min').value) || 0;
        texto += `\n----------------------------------------\nCÔMODO: ${nome.toUpperCase()} | PD Máx: ${pdMaxComodo.toFixed(2)}m | PD Mín: ${pdMinComodo.toFixed(2)}m\n----------------------------------------\n`;

        comodoDiv.querySelectorAll('.parede-bloco').forEach((paredeDiv, index) => {
            const comp = parseFloat(paredeDiv.querySelector('.parede-comprimento').value) || 0;
            texto += `\n◊ Parede ${index + 1} (${comp.toFixed(2)}m):\n`;
            paredeDiv.querySelectorAll('.servico-item').forEach(servicoDiv => {
                const res = processarServico(servicoDiv);
                if (res) {
                    if (res.isIntervention) {
                        const casasDecimais = res.unidade === 'm³' ? 3 : (res.unidade === 'un' ? 0 : 2);
                        texto += `  ▪ ${res.nome} = ${res.quant.toFixed(casasDecimais)} ${res.unidade} ${res.detalhe}\n`;
                    } else {
                        texto += `  ▪ ${res.nome}\n`;
                    }
                }
            });
        });
        
        let textoEstrutural = '\n◊ REPARO ESTRUTURAL:\n';
        let temServicoEstrutural = false;
        comodoDiv.querySelectorAll('.estrutural-container .servico-item').forEach(servicoDiv => {
            const res = processarServico(servicoDiv);
            if(res) {
                temServicoEstrutural = true;
                if (res.isIntervention) {
                    const casasDecimais = res.unidade === 'm³' ? 3 : (res.unidade === 'un' ? 0 : 2);
                    textoEstrutural += `  ▪ ${res.nome} = ${res.quant.toFixed(casasDecimais)} ${res.unidade} ${res.detalhe}\n`;
                } else {
                    textoEstrutural += `  ▪ ${res.nome}\n`;
                }
            }
        });
        if (temServicoEstrutural) texto += textoEstrutural;

        const processSubSection = (containerSelector, title, areaInfo) => {
            let subTexto = `\n◊ ${title} | Área: ${areaInfo.toFixed(2)} m²:\n`;
            let hasContent = false;
            comodoDiv.querySelectorAll(containerSelector).forEach(servicoDiv => {
                const res = processarServico(servicoDiv);
                if(res) {
                    hasContent = true;
                    if (res.isIntervention) {
                        const casasDecimais = res.unidade === 'm³' ? 3 : (res.unidade === 'un' ? 0 : 2);
                        subTexto += `  ▪ ${res.nome} = ${res.quant.toFixed(casasDecimais)} ${res.unidade} ${res.detalhe}\n`;
                    } else {
                        subTexto += `  ▪ ${res.nome}\n`;
                    }
                }
            });
            if (hasContent) texto += subTexto;
        };
        
        const areaPiso = parseFloat(comodoDiv.querySelector('.comodo-area-piso').value) || 0;
        const areaTeto = parseFloat(comodoDiv.querySelector('.comodo-area-teto').value) || 0;
        processSubSection('.piso-container .servico-item', 'PISO', areaPiso);
        processSubSection('.teto-container .servico-item', 'TETO', areaTeto);

        let textoServicosGerais = '\n◊ EQUIPAMENTOS GERAIS:\n';
        let temServicosGerais = false;
        comodoDiv.querySelectorAll('.equipamentos-container .servico-item').forEach(servicoDiv => {
            const res = processarServico(servicoDiv);
            if(res) {
                temServicosGerais = true;
                if (res.isIntervention) {
                    textoServicosGerais += `  ▪ ${res.nome} = ${res.quant.toFixed(0)} ${res.unidade} ${res.detalhe}\n`;
                } else {
                    textoServicosGerais += `  ▪ ${res.nome}\n`;
                }
            }
        });
        if (temServicosGerais) texto += textoServicosGerais;
    });

    texto += `\n\n========================================\nQUANTITATIVOS TOTAIS PARA ORÇAMENTO\n========================================\n`;
    for (const nome in totaisGerais) {
        const item = totaisGerais[nome];
        const casasDecimais = item.unidade === 'un' ? 0 : (item.unidade === 'm³' ? 3 : 2);
        texto += `- ${nome}: ${item.total.toFixed(casasDecimais)} ${item.unidade}\n`;
    }

    return texto;
}

async function gerarPDF() {
    document.querySelectorAll('.collapsible-content, .service-collapsible-content').forEach(el => el.classList.remove('hidden'));
    document.querySelectorAll('[data-action="toggle-collapse"]').forEach(btn => btn.textContent = 'Concluir Seção');
    document.querySelectorAll('[data-action="toggle-service"]').forEach(btn => btn.textContent = 'Fechar Serviço');

    const nomeBeneficiario = document.getElementById('nomeBeneficiario').value || "Beneficiario";
    const nomeArquivo = `Memorial_Descritivo_${nomeBeneficiario.replace(/ /g, "_")}.pdf`;
    const relatorioElement = document.getElementById('resumo-container');
    
    await html2canvas(relatorioElement, { scale: 2 }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF('p', 'pt', 'a4');
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        const imgWidth = pdfWidth - 80;
        const imgHeight = canvas.height * imgWidth / canvas.width;
        let heightLeft = imgHeight;
        let position = 40;

        pdf.addImage(imgData, 'PNG', 40, position, imgWidth, imgHeight);
        heightLeft -= (pdfHeight - 80);

        while (heightLeft > 0) {
            position -= (pdfHeight - 80);
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 40, position, imgWidth, imgHeight);
            heightLeft -= (pdfHeight - 80);
        }
        pdf.save(nomeArquivo);
    });
}

function handleAppActions(e) {
    const target = e.target.closest('[data-action]');
    if (!target) return;

    e.preventDefault(); 
    const action = target.dataset.action;
    let container, tipos = [];

    switch (action) {
        case 'add-comodo':
            const comodoId = `comodo_${nextId++}`;
            const comodoDiv = document.createElement('div');
            comodoDiv.className = 'bloco';
            comodoDiv.id = comodoId;
            comodoDiv.setAttribute('data-bloco-type', 'comodo');
            comodoDiv.innerHTML = `
                <h3><span>Novo Cômodo</span><button class="btn-remove" data-action="remove-element" data-target-id="${comodoId}">${REMOVE_ICON_SVG}</button></h3>
                <div class="collapsible-content">
                    <div class="campo"><label>Nome do Cômodo:</label><input type="text" class="comodo-nome" placeholder="Ex: Cozinha"></div>
                    <div class="grid-3-col">
                          <div class="campo"><label>PD Máximo (m):</label><input type="number" class="comodo-pd-max" placeholder="Ex: 2.85"></div>
                          <div class="campo"><label>PD Mínimo (m):</label><input type="number" class="comodo-pd-min" placeholder="Ex: 2.48"></div>
                    </div>
                    
                    <h4>Paredes do Cômodo</h4>
                    <div class="paredes-container"></div>
                    <button class="btn-add btn-add-small" data-action="add-parede">Adicionar Parede</button>
                    
                    <h4>Reparo Estrutural</h4>
                    <div class="estrutural-container servicos-container"></div>
                    <button class="btn-add btn-add-small" data-action="add-servico-estrutural">Adicionar Serviço Estrutural</button>

                    <h4>Piso do Cômodo</h4>
                    <div class="campo"><label>Área do Piso (m²):</label><input type="number" class="comodo-area-piso" placeholder="Área exata do piso"></div>
                    <div class="piso-container servicos-container"></div>
                    <button class="btn-add btn-add-small" data-action="add-servico-piso">Adicionar Serviço ao Piso</button>

                    <h4>Teto do Cômodo</h4>
                    <div class="campo"><label>Área do Teto (m²):</label><input type="number" class="comodo-area-teto" placeholder="Área exata do teto"></div>
                    <div class="teto-container servicos-container"></div>
                    <button class="btn-add btn-add-small" data-action="add-servico-teto">Adicionar Serviço ao Teto</button>

                    <h4>Equipamentos e Instalações Gerais</h4>
                    <div class="equipamentos-container servicos-container"></div>
                    <button class="btn-add btn-add-small" data-action="add-equipamento-geral">Adicionar Equipamento</button>
                </div>
                <button class="btn-toggle" data-action="toggle-collapse">Concluir Seção</button>
            `;
            document.getElementById('listaComodos').appendChild(comodoDiv);
            return;
        case 'add-servico-cobertura':
            container = target.closest('.bloco').querySelector('.servicos-container');
            tipos = ['cobertura', 'cobertura_linear'];
            break;
        case 'add-parede':
            const paredesContainer = target.closest('.bloco').querySelector('.paredes-container');
            const paredeId = `parede_${nextId++}`;
            const numParedes = paredesContainer.children.length + 1;
            const paredeDiv = document.createElement('div');
            paredeDiv.className = 'parede-bloco';
            paredeDiv.id = paredeId;
            paredeDiv.innerHTML = `
                <h5><span>Parede ${numParedes}</span><button class="btn-remove" data-action="remove-element" data-target-id="${paredeId}">${REMOVE_ICON_SVG}</button></h5>
                <div class="campo"><label>Comprimento da Parede (m):</label><input type="number" class="parede-comprimento"></div>
                <div class="servicos-container"></div>
                <button class="btn-add btn-add-small" data-action="add-servico-parede">Adicionar Serviço à Parede</button>
            `;
            paredesContainer.appendChild(paredeDiv);
            return; 
        case 'add-servico-parede':
            container = target.closest('.parede-bloco').querySelector('.servicos-container');
            tipos = ['parede_area_custom', 'parede_vol_custom', 'unitario_parede'];
            break;
        case 'add-servico-piso':
            container = target.closest('.bloco').querySelector('.piso-container');
            tipos = ['piso_custom', 'piso_vol_custom', 'piso_linear', 'piso_unitario'];
            break;
        case 'add-servico-teto':
            container = target.closest('.bloco').querySelector('.teto-container');
            tipos = ['teto_custom', 'unitario_teto'];
            break;
        case 'add-servico-estrutural':
            container = target.closest('.bloco').querySelector('.estrutural-container');
            tipos = ['estrutural_area', 'estrutural_linear', 'estrutural_unitario'];
            break;
        case 'add-equipamento-geral':
            container = target.closest('.bloco').querySelector('.equipamentos-container');
            tipos = ['equipamento_geral'];
            break;
        case 'remove-element':
            const elementToRemove = document.getElementById(target.dataset.targetId);
            if (elementToRemove) elementToRemove.remove();
            return;
        case 'toggle-collapse':
            const content = target.closest('.bloco').querySelector('.collapsible-content');
            content.classList.toggle('hidden');
            target.textContent = content.classList.contains('hidden') ? 'Editar' : 'Concluir Seção';
            return;
        case 'toggle-service':
            const serviceContent = target.closest('.servico-item').querySelector('.service-collapsible-content');
            serviceContent.classList.toggle('hidden');
            target.textContent = serviceContent.classList.contains('hidden') ? 'Editar Serviço' : 'Fechar Serviço';
            return;
        // Cases para salvar e carregar adicionados aqui
        case 'salvar-rascunho':
            salvarEstado();
            return;
        case 'carregar-rascunho':
            if (confirm('Isso irá substituir todos os dados atuais. Deseja continuar?')) {
                carregarEstado();
            }
            return;
        case 'gerar-relatorio':
            let erroDeValidacao = null;
            const todosOsServicos = document.querySelectorAll('.servico-item');

            for (const servicoDiv of todosOsServicos) {
                const select = servicoDiv.querySelector('select');
                if (!select || !select.value || select.value === 'sem_intervencao') {
                    continue;
                }

                const servicoKey = select.value;
                const servico = SERVICOS_DB[servicoKey];
                const nomeServico = servico.nome;

                const getContexto = (el) => {
                    const parede = el.closest('.parede-bloco');
                    const comodo = el.closest('.bloco[data-bloco-type="comodo"]');
                    const cobertura = el.closest('.bloco[data-bloco-type="cobertura"]');

                    if (parede) {
                        const numParede = Array.from(parede.parentElement.children).indexOf(parede) + 1;
                        const nomeComodo = comodo.querySelector('.comodo-nome').value || 'Cômodo';
                        return `[${nomeComodo} -> Parede ${numParede}]`;
                    }
                    if (comodo) {
                        return `[${comodo.querySelector('.comodo-nome').value || 'Cômodo'}]`;
                    }
                    if (cobertura) {
                        return '[Cobertura]';
                    }
                    return '[Local não identificado]';
                };
                const contexto = getContexto(servicoDiv);

                const checkInput = (selector, fieldName) => {
                    const input = servicoDiv.querySelector(selector);
                    if (input && (input.value === '' || input.value === null)) {
                        return `ERRO: Preencha o campo "${fieldName}" para o serviço "${nomeServico}" em ${contexto}.`;
                    }
                    return null;
                };
                
                const checkMainInput = (selector, fieldName, contextElement) => {
                       const input = contextElement.querySelector(selector);
                       if (input && (input.value === '' || input.value === null)) {
                         return `ERRO: Preencha o campo "${fieldName}" em ${contexto} para calcular o serviço "${nomeServico}".`;
                       }
                       return null;
                };

                switch (servico.tipo) {
                    case 'parede_area_custom':
                    case 'estrutural_area':
                        erroDeValidacao = checkInput('[name="custom_comp"]', 'Comprimento a aplicar') || checkInput('[name="custom_larg"]', 'Largura a aplicar');
                        break;
                    case 'parede_vol_custom':
                        erroDeValidacao = checkInput('[name="custom_comp"]', 'Comprimento a demolir') || checkInput('[name="custom_alt"]', 'Altura a demolir');
                        break;
                    case 'cobertura_linear':
                    case 'estrutural_linear':
                    case 'piso_linear':
                        erroDeValidacao = checkInput('[name="medida"]', 'Comprimento');
                        break;
                    case 'cobertura':
                          erroDeValidacao = checkMainInput('#areaTelhado', 'Área do Telhado', document.getElementById('bloco-cobertura'));
                          break;
                    case 'piso_custom':
                    case 'piso_vol_custom':
                          erroDeValidacao = checkMainInput('.comodo-area-piso', 'Área do Piso', servicoDiv.closest('.bloco'));
                          break;
                    case 'teto_custom':
                          erroDeValidacao = checkMainInput('.comodo-area-teto', 'Área do Teto', servicoDiv.closest('.bloco'));
                          break;
                }

                if (erroDeValidacao) {
                    break; 
                }
            }

            if (erroDeValidacao) {
                alert(erroDeValidacao);
                return;
            }
            
            const textoFinal = gerarRelatorio();
            document.getElementById('resumo').textContent = textoFinal;
            document.getElementById('output').style.display = 'block';
            document.getElementById('gerarPDF').style.display = 'inline-block';
            return;
        case 'gerar-pdf':
            document.querySelectorAll('.collapsible-content, .service-collapsible-content').forEach(el => el.classList.remove('hidden'));
            document.querySelectorAll('[data-action="toggle-collapse"]').forEach(btn => btn.textContent = 'Concluir Seção');
            document.querySelectorAll('[data-action="toggle-service"]').forEach(btn => btn.textContent = 'Fechar Serviço');
            gerarPDF();
            return;
        default:
            return;
    }

    if (container) {
        const servicoId = `servico_${nextId++}`;
        const servicoDiv = document.createElement('div');
        servicoDiv.className = 'servico-item';
        servicoDiv.id = servicoId;
        
        const select = document.createElement('select');
        popularSelectServicos(select, tipos);

        servicoDiv.innerHTML = `
            <div class="service-header">
                <strong></strong>
                <div class="header-buttons">
                    <button class="btn-remove" data-action="remove-element" data-target-id="${servicoId}">${REMOVE_ICON_SVG}</button>
                </div>
            </div>
            <div class="service-collapsible-content"></div>
        `;
        
        const content = servicoDiv.querySelector('.service-collapsible-content');
        const label = document.createElement('label');
        label.textContent = 'Serviço:';

        content.appendChild(label);
        content.appendChild(select);
        content.innerHTML += `<div class="campos-especificos" style="margin-top:10px;"></div>`;
        container.appendChild(servicoDiv);
    }
}

document.addEventListener('input', (e) => {
    const target = e.target;
    const servicoDiv = target.closest('.servico-item');
    if(servicoDiv) {
        if(target.matches('[name="custom_comp"], [name="custom_larg"]')) {
            const comp = parseFloat(servicoDiv.querySelector('[name="custom_comp"]')?.value) || 0;
            const larg = parseFloat(servicoDiv.querySelector('[name="custom_larg"]')?.value) || 0;
            const totalSpan = servicoDiv.querySelector('.area-total');
            if(totalSpan) totalSpan.textContent = (comp * larg).toFixed(2);
        }
        if(target.matches('[name="custom_comp"], [name="custom_alt"]')) {
            const comp = parseFloat(servicoDiv.querySelector('[name="custom_comp"]')?.value) || 0;
            const alt = parseFloat(servicoDiv.querySelector('[name="custom_alt"]')?.value) || 0;
            const totalSpan = servicoDiv.querySelector('.area-total');
            if(totalSpan) totalSpan.textContent = (comp * alt).toFixed(2);
        }
        if(target.matches('[name="custom_comp"], [name="custom_alt"], [name="espessura"]')) {
            const comp = parseFloat(servicoDiv.querySelector('[name="custom_comp"]')?.value) || 0;
            const alt = parseFloat(servicoDiv.querySelector('[name="custom_alt"]')?.value) || 0;
            const esp = parseFloat(servicoDiv.querySelector('[name="espessura"]')?.value) || 0;
            const totalSpan = servicoDiv.querySelector('.vol-total');
            if(totalSpan) totalSpan.textContent = (comp * alt * esp).toFixed(3);
        }
    }
});

document.addEventListener('change', (e) => {
    const target = e.target;
    if (target.matches('select')) {
        const servicoDiv = target.closest('.servico-item');
        if (servicoDiv) {
            gerarCamposServico(servicoDiv, target.value);
            const header = servicoDiv.querySelector('.service-header');
            const servicoId = servicoDiv.id;

            if (target.value) {
                const serviceName = (target.value === 'sem_intervencao')
                    ? 'Sem intervenção'
                    : target.options[target.selectedIndex].text;
                
                header.innerHTML = `
                    <strong>${serviceName}</strong>
                    <div class="header-buttons">
                        <button class="btn-toggle-service" data-action="toggle-service">Fechar Serviço</button>
                        <button class="btn-remove" data-action="remove-element" data-target-id="${servicoId}">${REMOVE_ICON_SVG}</button>
                    </div>
                `;
            } else {
                header.innerHTML = `
                    <strong></strong>
                    <div class="header-buttons">
                        <button class="btn-remove" data-action="remove-element" data-target-id="${servicoId}">${REMOVE_ICON_SVG}</button>
                    </div>
                `;
            }
        }
    }
});

['click', 'touchend'].forEach(evt => {
    document.addEventListener(evt, handleAppActions);
});


// ==========================================================
//      NOVA LÓGICA PARA SALVAR E CARREGAR ESTADO
// ==========================================================

const CHAVE_STORAGE = 'levantamentoHabitacionalSalvo';

/**
 * Coleta todos os dados do formulário e retorna um objeto.
 */
function coletarEstadoAtual() {
    const estado = {
        beneficiario: document.getElementById('nomeBeneficiario').value,
        endereco: document.getElementById('enderecoBeneficiario').value,
        responsavel: document.getElementById('nomeResponsavel').value,
        cobertura: {
            area: document.getElementById('areaTelhado').value,
            pdMax: document.getElementById('pdMaximo').value,
            pdMin: document.getElementById('pdMinimo').value,
            servicos: []
        },
        comodos: []
    };

    // Coletar serviços da cobertura
    document.querySelectorAll('#bloco-cobertura .servico-item').forEach(servicoDiv => {
        const select = servicoDiv.querySelector('select');
        if (!select || !select.value) return;
        const campos = {};
        servicoDiv.querySelectorAll('.campos-especificos input').forEach(input => {
            campos[input.name] = input.value;
        });
        estado.cobertura.servicos.push({
            id: select.value,
            campos: campos
        });
    });

    // Coletar dados dos cômodos
    document.querySelectorAll('#listaComodos > .bloco').forEach(comodoDiv => {
        const comodoObj = {
            nome: comodoDiv.querySelector('.comodo-nome').value,
            pdMax: comodoDiv.querySelector('.comodo-pd-max').value,
            pdMin: comodoDiv.querySelector('.comodo-pd-min').value,
            areaPiso: comodoDiv.querySelector('.comodo-area-piso').value,
            areaTeto: comodoDiv.querySelector('.comodo-area-teto').value,
            paredes: [],
            pisoServicos: [],
            tetoServicos: [],
            estruturalServicos: [],
            equipamentos: []
        };
        
        // Paredes e seus serviços
        comodoDiv.querySelectorAll('.parede-bloco').forEach(paredeDiv => {
            const paredeObj = {
                comprimento: paredeDiv.querySelector('.parede-comprimento').value,
                servicos: []
            };
            paredeDiv.querySelectorAll('.servico-item').forEach(servicoDiv => {
                const select = servicoDiv.querySelector('select');
                if (!select || !select.value) return;
                const campos = {};
                servicoDiv.querySelectorAll('.campos-especificos input').forEach(input => {
                    campos[input.name] = input.value;
                });
                paredeObj.servicos.push({ id: select.value, campos: campos });
            });
            comodoObj.paredes.push(paredeObj);
        });
        
        // Função auxiliar para coletar serviços de outras seções
        const coletarServicosSecao = (containerSelector, targetArray) => {
             comodoDiv.querySelectorAll(`${containerSelector} .servico-item`).forEach(servicoDiv => {
                const select = servicoDiv.querySelector('select');
                if (!select || !select.value) return;
                const campos = {};
                servicoDiv.querySelectorAll('.campos-especificos input').forEach(input => {
                    campos[input.name] = input.value;
                });
                targetArray.push({ id: select.value, campos: campos });
            });
        };
        
        coletarServicosSecao('.piso-container', comodoObj.pisoServicos);
        coletarServicosSecao('.teto-container', comodoObj.tetoServicos);
        coletarServicosSecao('.estrutural-container', comodoObj.estruturalServicos);
        coletarServicosSecao('.equipamentos-container', comodoObj.equipamentos);

        estado.comodos.push(comodoObj);
    });

    return estado;
}


/**
 * Salva o estado atual do formulário no localStorage.
 */
function salvarEstado() {
    try {
        const estadoAtual = coletarEstadoAtual();
        localStorage.setItem(CHAVE_STORAGE, JSON.stringify(estadoAtual));
        alert('Rascunho salvo com sucesso!');
    } catch (error) {
        console.error("Erro ao salvar o estado:", error);
        alert('Ocorreu um erro ao tentar salvar. Verifique o console para mais detalhes.');
    }
}


/**
 * Carrega um estado salvo e reconstrói o formulário.
 */
function carregarEstado() {
    const estadoSalvo = localStorage.getItem(CHAVE_STORAGE);
    if (!estadoSalvo) {
        alert('Nenhum rascunho encontrado.');
        return;
    }

    try {
        const estado = JSON.parse(estadoSalvo);
        
        // Limpa o formulário atual
        document.getElementById('listaComodos').innerHTML = '';
        document.querySelector('#bloco-cobertura .servicos-container').innerHTML = '';

        // Preenche dados básicos
        document.getElementById('nomeBeneficiario').value = estado.beneficiario || '';
        document.getElementById('enderecoBeneficiario').value = estado.endereco || '';
        document.getElementById('nomeResponsavel').value = estado.responsavel || '';
        document.getElementById('areaTelhado').value = estado.cobertura.area || '';
        document.getElementById('pdMaximo').value = estado.cobertura.pdMax || '';
        document.getElementById('pdMinimo').value = estado.cobertura.pdMin || '';
        
        // Recria os serviços da cobertura
        const coberturaContainer = document.querySelector('#bloco-cobertura .servicos-container');
        estado.cobertura.servicos.forEach(servicoData => {
            document.querySelector('[data-action="add-servico-cobertura"]').click();
            const novoServicoDiv = coberturaContainer.lastElementChild;
            const select = novoServicoDiv.querySelector('select');
            select.value = servicoData.id;
            select.dispatchEvent(new Event('change')); // Dispara o evento para criar os campos
            for(const nomeCampo in servicoData.campos) {
                const input = novoServicoDiv.querySelector(`[name="${nomeCampo}"]`);
                if(input) input.value = servicoData.campos[nomeCampo];
            }
        });

        // Recria os cômodos
        estado.comodos.forEach(comodoData => {
            document.getElementById('addComodo').click();
            const novoComodoDiv = document.getElementById('listaComodos').lastElementChild;
            
            // Preenche dados do cômodo
            novoComodoDiv.querySelector('.comodo-nome').value = comodoData.nome;
            novoComodoDiv.querySelector('.comodo-pd-max').value = comodoData.pdMax;
            novoComodoDiv.querySelector('.comodo-pd-min').value = comodoData.pdMin;
            novoComodoDiv.querySelector('.comodo-area-piso').value = comodoData.areaPiso;
            novoComodoDiv.querySelector('.comodo-area-teto').value = comodoData.areaTeto;

            // Recria as paredes
            comodoData.paredes.forEach(paredeData => {
                novoComodoDiv.querySelector('[data-action="add-parede"]').click();
                const novaParedeDiv = novoComodoDiv.querySelector('.paredes-container').lastElementChild;
                novaParedeDiv.querySelector('.parede-comprimento').value = paredeData.comprimento;
                
                // Recria serviços da parede
                paredeData.servicos.forEach(servicoData => {
                    novaParedeDiv.querySelector('[data-action="add-servico-parede"]').click();
                    const novoServicoDiv = novaParedeDiv.querySelector('.servicos-container').lastElementChild;
                    const select = novoServicoDiv.querySelector('select');
                    select.value = servicoData.id;
                    select.dispatchEvent(new Event('change'));
                    for(const nomeCampo in servicoData.campos) {
                        const input = novoServicoDiv.querySelector(`[name="${nomeCampo}"]`);
                        if(input) input.value = servicoData.campos[nomeCampo];
                    }
                });
            });
            
            // Função auxiliar para recriar serviços de outras seções
            const recriarServicosSecao = (action, containerSelector, servicosArray) => {
                 servicosArray.forEach(servicoData => {
                    novoComodoDiv.querySelector(`[data-action="${action}"]`).click();
                    const container = novoComodoDiv.querySelector(containerSelector);
                    const novoServicoDiv = container.lastElementChild;
                    const select = novoServicoDiv.querySelector('select');
                    select.value = servicoData.id;
                    select.dispatchEvent(new Event('change'));
                    for (const nomeCampo in servicoData.campos) {
                        const input = novoServicoDiv.querySelector(`[name="${nomeCampo}"]`);
                        if (input) input.value = servicoData.campos[nomeCampo];
                    }
                });
            };

            recriarServicosSecao('add-servico-piso', '.piso-container', comodoData.pisoServicos);
            recriarServicosSecao('add-servico-teto', '.teto-container', comodoData.tetoServicos);
            recriarServicosSecao('add-servico-estrutural', '.estrutural-container', comodoData.estruturalServicos);
            recriarServicosSecao('add-equipamento-geral', '.equipamentos-container', comodoData.equipamentos);
        });

        alert('Rascunho carregado com sucesso!');

    } catch (error) {
        console.error("Erro ao carregar o estado:", error);
        alert('Ocorreu um erro ao carregar o rascunho. Pode ser que o rascunho salvo seja de uma versão antiga da ferramenta. Verifique o console.');
        localStorage.removeItem(CHAVE_STORAGE); // Limpa o rascunho corrompido
    }
}

// Verifica se existe um rascunho ao carregar a página
document.addEventListener('DOMContentLoaded', () => {
    if (localStorage.getItem(CHAVE_STORAGE)) {
        if (confirm('Encontramos um rascunho salvo. Deseja carregá-lo?')) {
            carregarEstado();
        }
    }
});
</script>
</body>
</html>